<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lesson 4 | New Media and Technology Aids</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: "#E7F7F5", 100: "#CFF0EC", 200: "#9FE1D9", 300: "#6ED2C6", 400: "#3EC3B3",
                500: "#13A89A", 600: "#0F877B", 700: "#0B665C", 800: "#07453E", 900: "#032420",
              },
            },
            boxShadow: { soft: "0 10px 30px rgba(0,0,0,0.10)" },
          },
        },
      };
    </script>
    <style>
      .page-bg {
        background: radial-gradient(1200px 500px at 10% -10%, rgba(19, 168, 154, 0.12), transparent 55%),
          radial-gradient(900px 450px at 100% 0%, rgba(19, 168, 154, 0.10), transparent 50%),
          #fff;
      }
    </style>
  </head>

  <body class="page-bg text-slate-800">
    <!-- NAVBAR ✅ EXACT SAME as lessons.html -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-100">
      <nav class="mx-auto flex max-w-7xl items-center justify-between px-4 py-4 sm:px-6 lg:px-8">
        <!-- Brand -->
        <a href="index.html" class="flex items-center gap-3">
          <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-brand-50 ring-1 ring-black/5">
            <svg viewBox="0 0 24 24" class="h-6 w-6 text-brand-700" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 7l8-4 8 4v10l-8 4-8-4V7z"></path>
              <path d="M8 11l2 2 5-5"></path>
            </svg>
          </div>
          <span class="text-lg font-semibold tracking-tight text-slate-900">Purposive Communication</span>
        </a>

        <!-- Desktop Links + Login/User Dropdown -->
        <div class="hidden items-center gap-8 md:flex">
          <a href="index.html" class="text-sm font-medium text-slate-700 hover:text-brand-700">Home</a>
          <a href="lessons.html" class="text-sm font-semibold text-brand-700">Lessons</a>

          <!-- Login (GUEST ONLY) -->
          <a href="login.html" id="openLoginBtn"
            class="auth-guest rounded-xl bg-brand-500 px-5 py-2.5 text-sm font-semibold text-white shadow-soft hover:bg-brand-600">
            Login
          </a>

          <!-- User dropdown (LOGGED IN ONLY) -->
          <div class="auth-user hidden relative">
            <button id="userMenuBtn" type="button"
              class="inline-flex items-center gap-3 rounded-2xl bg-white px-2 py-1.5 ring-1 ring-black/5 shadow-sm hover:bg-slate-50 hover:shadow-soft transition"
              aria-haspopup="menu" aria-expanded="false">
              <div id="navAvatar"
                class="h-9 w-9 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center text-slate-700 font-extrabold">
                U
              </div>
              <span id="navName" class="text-sm font-semibold text-slate-900">Student</span>
              <svg id="navCaret" class="h-4 w-4 text-slate-500 transition-transform" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
              </svg>
            </button>

            <!-- Dropdown panel -->
            <div id="userDropdown"
              class="absolute right-[-10px] mt-3 hidden w-[290px] overflow-hidden rounded-3xl bg-white shadow-soft ring-1 ring-black/10">
              <div class="p-3">
                <div class="rounded-2xl bg-brand-50 p-3 ring-1 ring-brand-100">
                  <div class="flex items-start gap-3">
                    <div id="ddAvatar"
                      class="h-11 w-11 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center text-slate-700 font-extrabold text-lg">
                    </div>
                    <div class="min-w-0">
                      <p id="ddName" class="truncate text-sm font-extrabold text-slate-900">Student</p>
                      <p class="text-xs font-semibold text-slate-500">Student</p>
                    </div>
                  </div>
                </div>

                <div class="mt-3 space-y-2 text-sm">
                  <div class="flex items-center gap-3 rounded-xl bg-white px-3 py-2 ring-1 ring-black/5">
                    <svg class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M22 6l-10 7L2 6" />
                    </svg>
                    <span id="ddEmail" class="truncate text-slate-700">email@example.com</span>
                  </div>

                  <div class="flex items-center gap-3 rounded-xl bg-white px-3 py-2 ring-1 ring-black/5">
                    <svg class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <rect x="3" y="5" width="18" height="14" rx="2" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 15h4" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 9h10" />
                    </svg>
                    <span class="text-slate-700">ID: <span id="ddId" class="font-semibold text-slate-800">—</span></span>
                  </div>
                </div>

                <div class="mt-3 grid grid-cols-2 gap-2">
                  <a href="profile.html"
                    class="inline-flex items-center justify-center rounded-2xl bg-brand-800 px-4 py-2.5 text-sm font-semibold text-white hover:bg-brand-900 transition">
                    View profile
                  </a>
                  <button id="signOutBtn" type="button"
                    class="inline-flex items-center justify-center rounded-2xl bg-slate-100 px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-200 transition">
                    Sign out
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile -->
        <button
          id="menuBtn"
          class="inline-flex items-center justify-center rounded-xl bg-slate-50 p-2 text-slate-800 ring-1 ring-black/5 hover:bg-slate-100 md:hidden"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </nav>

      <!-- Mobile Menu -->
      <div id="mobileMenu" class="mx-auto hidden max-w-7xl px-4 pb-4 sm:px-6 lg:px-8 md:hidden">
        <div class="rounded-2xl bg-white p-4 shadow-soft ring-1 ring-black/5">
          <div class="flex flex-col gap-2">
            <a href="index.html" class="rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">Home</a>
            <a href="lessons.html" class="rounded-xl px-3 py-2 text-sm font-semibold text-brand-700 bg-brand-50">Lessons</a>
            <a href="profile.html" class="rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">Profile</a>

            <!-- Login (GUEST ONLY) -->
            <a href="login.html" id="openLoginMobile"
              class="auth-guest mt-2 rounded-xl bg-brand-500 px-4 py-2.5 text-center text-sm font-semibold text-white hover:bg-brand-600">
              Login
            </a>

            <!-- Logged-in block (MOBILE ONLY) -->
            <div class="auth-user hidden mt-2 rounded-2xl bg-white ring-1 ring-black/5 p-3">
              <div class="flex items-center gap-3">
                <div id="mNavAvatar"
                  class="h-10 w-10 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center font-extrabold text-slate-700">
                  U
                </div>
                <div class="min-w-0">
                  <p id="mNavName" class="truncate text-sm font-extrabold text-slate-900">Student</p>
                  <p id="mNavEmail" class="truncate text-xs font-semibold text-slate-500">email@example.com</p>
                </div>
              </div>
              <div class="mt-3 grid grid-cols-2 gap-2">
                <a href="profile.html"
                  class="rounded-xl bg-brand-800 px-3 py-2 text-center text-sm font-semibold text-white hover:bg-brand-900">View profile</a>
                <button id="mSignOutBtn"
                  class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200">Sign out</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </header>

    <section class="bg-brand-700">
      <div class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
          <div>
            <p class="text-white/80 text-sm font-semibold">Lesson 4</p>
            <h1 class="mt-1 text-3xl sm:text-4xl font-extrabold tracking-tight text-white">
              The Rise of New Media and Technology Aids in Communication
            </h1>
            <p class="mt-3 max-w-3xl text-white/85">Part 1 (Lesson/Module) • Part 2 (Assessment — File Submission)</p>
          </div>

          <div class="w-full md:w-[340px]">
            <div class="rounded-2xl bg-white/10 ring-1 ring-white/15 p-4">
              <div class="flex items-center justify-between text-sm text-white/90">
                <span class="font-semibold">Lesson Progress</span>
                <span id="progressText" class="font-bold">0%</span>
              </div>
              <div class="mt-3 h-2.5 w-full rounded-full bg-white/20">
                <div id="progressBar" class="h-2.5 w-0 rounded-full bg-white transition-all"></div>
              </div>
              <p class="mt-2 text-xs text-white/70">File upload stores filename only.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <main class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8">
      <div class="grid gap-8 lg:grid-cols-12">
        <aside class="lg:col-span-3">
          <div class="rounded-3xl bg-white shadow-soft ring-1 ring-black/5 p-5 sticky top-24">
            <h2 class="text-sm font-extrabold text-slate-900">Lesson Parts</h2>
            <div id="partsList" class="mt-4 space-y-2"></div>
          </div>
        </aside>

        <section class="lg:col-span-9">
          <div class="rounded-3xl bg-white shadow-soft ring-1 ring-black/5 p-6 sm:p-8">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 id="partTitle" class="text-2xl font-extrabold text-slate-900"></h2>
                <p id="partSubtitle" class="mt-2 text-sm text-slate-600"></p>
              </div>
              <span id="statusPill" class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ring-1 ring-black/5">
                Not completed
              </span>
            </div>

            <div id="partBody" class="mt-6 space-y-6"></div>

            <div class="mt-8 flex flex-col-reverse gap-3 sm:flex-row sm:items-center sm:justify-between">
              <button id="prevBtn" class="rounded-xl bg-slate-100 px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-200 ring-1 ring-black/5">
                ← Previous
              </button>

              <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-end">
                <button id="completeBtn" class="rounded-xl bg-brand-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-brand-700 ring-1 ring-black/5">
                  Mark Part as Completed
                </button>
                <button id="nextBtn" class="rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800 ring-1 ring-black/5">
                  Next →
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script>
      // ===== Auth dropdown logic (same behavior as lessons.html) =====
      const LS_AUTH = {
        session: "pc_session",
        users: "pc_users",
        avatar: "pc_profile_avatar",
        loggedIn: "pc_logged_in"
      };

      const guestEls = Array.from(document.querySelectorAll(".auth-guest"));
      const userEls = Array.from(document.querySelectorAll(".auth-user"));

      const userMenuBtn = document.getElementById("userMenuBtn");
      const userDropdown = document.getElementById("userDropdown");
      const navCaret = document.getElementById("navCaret");

      const navName = document.getElementById("navName");
      const navAvatar = document.getElementById("navAvatar");

      const ddName = document.getElementById("ddName");
      const ddEmail = document.getElementById("ddEmail");
      const ddId = document.getElementById("ddId");
      const ddAvatar = document.getElementById("ddAvatar");

      const mNavName = document.getElementById("mNavName");
      const mNavEmail = document.getElementById("mNavEmail");
      const mNavAvatar = document.getElementById("mNavAvatar");

      const signOutBtn = document.getElementById("signOutBtn");
      const mSignOutBtn = document.getElementById("mSignOutBtn");

      function safeParseJSONAuth(v, fallback) {
        try { return JSON.parse(v); } catch { return fallback; }
      }
      function getSessionAuth() {
        const raw = localStorage.getItem(LS_AUTH.session);
        return raw ? safeParseJSONAuth(raw, null) : null;
      }
      function getUsersAuth() {
        const raw = localStorage.getItem(LS_AUTH.users);
        return raw ? safeParseJSONAuth(raw, []) : [];
      }
      function isLoggedInAuth() {
        const s = getSessionAuth();
        return !!(s && s.email);
      }
      function getInitialsAuth(name) {
        const n = (name || "").trim();
        if (!n) return "U";
        const parts = n.split(/\s+/).filter(Boolean);
        const first = parts[0]?.[0] || "U";
        const last = parts.length > 1 ? parts[parts.length - 1][0] : "";
        return (first + last).toUpperCase();
      }
      function getAvatarDisplayAuth(userName) {
        const raw = localStorage.getItem(LS_AUTH.avatar);
        const obj = raw ? safeParseJSONAuth(raw, null) : null;
        if (obj && obj.type === "emoji" && obj.value) return { type: "emoji", value: obj.value };
        return { type: "initials", value: getInitialsAuth(userName) };
      }
      function setAvatarEl(el, avatar) {
        if (!el) return;
        el.textContent = avatar.value;
      }
      function closeUserDropdown() {
        if (!userDropdown || !userMenuBtn) return;
        userDropdown.classList.add("hidden");
        userMenuBtn.setAttribute("aria-expanded", "false");
        navCaret?.classList.remove("rotate-180");
      }
      function openUserDropdown() {
        if (!userDropdown || !userMenuBtn) return;
        userDropdown.classList.remove("hidden");
        userMenuBtn.setAttribute("aria-expanded", "true");
        navCaret?.classList.add("rotate-180");
      }
      function toggleUserDropdown() {
        if (!userDropdown) return;
        const isOpen = !userDropdown.classList.contains("hidden");
        if (isOpen) closeUserDropdown();
        else openUserDropdown();
      }

      userMenuBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        toggleUserDropdown();
      });

      document.addEventListener("click", (e) => {
        if (!userDropdown || userDropdown.classList.contains("hidden")) return;
        const wrapper = userMenuBtn?.parentElement; // .auth-user
        if (wrapper && e.target instanceof Node && !wrapper.contains(e.target)) closeUserDropdown();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeUserDropdown();
      });

      function applyAuthUI() {
        const loggedIn = isLoggedInAuth();
        localStorage.setItem(LS_AUTH.loggedIn, loggedIn ? "true" : "false");

        guestEls.forEach(el => el.classList.toggle("hidden", loggedIn));
        userEls.forEach(el => el.classList.toggle("hidden", !loggedIn));

        if (!loggedIn) {
          closeUserDropdown();
          return;
        }

        const session = getSessionAuth();
        const email = (session?.email || "").toLowerCase();
        const users = getUsersAuth();
        const found = users.find(u => (u.email || "").toLowerCase() === email) || null;

        const fullName = (session?.fullName || found?.fullName || "Student").trim();
        const studentId = (found?.studentId || "—").trim() || "—";

        const avatar = getAvatarDisplayAuth(fullName);

        if (navName) navName.textContent = fullName;
        if (ddName) ddName.textContent = fullName;
        if (ddEmail) ddEmail.textContent = session?.email || found?.email || "";
        if (ddId) ddId.textContent = studentId;

        setAvatarEl(navAvatar, avatar);
        setAvatarEl(ddAvatar, avatar);

        if (mNavName) mNavName.textContent = fullName;
        if (mNavEmail) mNavEmail.textContent = session?.email || found?.email || "";
        setAvatarEl(mNavAvatar, avatar);
      }

      function signOut() {
        localStorage.removeItem(LS_AUTH.session);
        localStorage.setItem(LS_AUTH.loggedIn, "false");
        closeUserDropdown();
        applyAuthUI();
      }

      signOutBtn?.addEventListener("click", signOut);
      mSignOutBtn?.addEventListener("click", signOut);

      window.addEventListener("storage", (e) => {
        if (e.key === LS_AUTH.session || e.key === LS_AUTH.avatar) {
          applyAuthUI();
        }
      });

      applyAuthUI();
      window.addEventListener("focus", applyAuthUI);

      // ===== your existing Lesson 4 script (UNCHANGED) =====
      const LESSON_NO = 4;

      // ===== Per-user storage (separate progress per account) =====
      const AUTH = { session: "pc_session" };
      function safeParseJSON(v, fallback) { try { return JSON.parse(v); } catch { return fallback; } }
      function getSession() {
        const raw = localStorage.getItem(AUTH.session);
        return raw ? safeParseJSON(raw, null) : null;
      }
      const __session = getSession();
      const __email = (__session?.email || "").trim().toLowerCase();
      if (!__email) {
        alert("Please log in first.");
        window.location.href = "login.html";
        throw new Error("Not logged in");
      }
      function uKey(baseKey) {
        return `pc_user:${__email}:${baseKey}`;
      }

      // Guard: lessons are sequential (must finish lesson 3 first)
      if (localStorage.getItem(uKey("pc_lesson3_complete")) !== "true") {
        alert("Please complete Lesson 3 first.");
        window.location.href = "lessons.html";
        throw new Error("Lesson locked");
      }

      const LS = {
        partDone: (p) => uKey(`pc_lesson${LESSON_NO}_part${p}_done`),
        progress: uKey(`pc_lesson${LESSON_NO}_progress`),
        complete: uKey(`pc_lesson${LESSON_NO}_complete`),
        assessmentFile: uKey(`pc_lesson${LESSON_NO}_assessment_file`),
      };

      // ==============================================================
      // ADMIN DASHBOARD SYNC (prototype - LocalStorage)
      // Keeps admin.html updated with each student's progress/scores.
      // ==============================================================
      const ADMIN_STORE_KEY = "pc_admin_students_state_v1";
      const USERS_STORE_KEY = "pc_users";

      const LESSON_META = {
        1: { title: "Lesson 1: Communication Principles and Ethics", parts: 4 },
        2: { title: "Lesson 2: Local and Global Communication in Multicultural Settings", parts: 2 },
        3: { title: "Lesson 3: Evaluating Messages and Images of Different Text Types", parts: 2 },
        4: { title: "Lesson 4: The Rise of New Media and Technology Aids in Communication", parts: 2 },
      };

      function safeJSON(v, fallback) { try { return JSON.parse(v); } catch { return fallback; } }

      function relTimeFromTs(ts) {
        const n = Number(ts || 0);
        if (!n) return "—";
        const diffMs = Date.now() - n;
        const diffMin = Math.max(0, Math.floor(diffMs / 60000));
        if (diffMin < 60) return `${diffMin || 1} minutes ago`;
        const diffHr = Math.floor(diffMin / 60);
        if (diffHr < 24) return `${diffHr} hours ago`;
        const diffDay = Math.floor(diffHr / 24);
        return `${diffDay} days ago`;
      }

      function touchLastActive() {
        localStorage.setItem(uKey("pc_last_active_ts"), String(Date.now()));
      }

      function getTimeSpentMin(n) {
        const ms = Number(localStorage.getItem(uKey(`pc_lesson${n}_time_spent_ms`)) || 0);
        return Math.max(0, Math.round(ms / 60000));
      }

      function computeLessonModel(n) {
        const meta = LESSON_META[n];
        const partsTotal = meta.parts;
        let partsDone = 0;
        for (let p = 1; p <= partsTotal; p++) {
          if (localStorage.getItem(uKey(`pc_lesson${n}_part${p}_done`)) === "true") partsDone++;
        }
        const pct = Math.round((partsDone / partsTotal) * 100);

        localStorage.setItem(uKey(`pc_lesson${n}_progress`), String(pct));
        localStorage.setItem(uKey(`pc_lesson${n}_complete`), pct === 100 ? "true" : "false");

        const startedK = uKey(`pc_lesson${n}_started_at`);
        const completedK = uKey(`pc_lesson${n}_completed_at`);
        if (!localStorage.getItem(startedK) && pct > 0) localStorage.setItem(startedK, new Date().toISOString());
        if (pct === 100 && !localStorage.getItem(completedK)) localStorage.setItem(completedK, new Date().toISOString());

        let state = "Not started";
        if (pct === 100) state = "Completed";
        else if (pct > 0) state = "In progress";

        return {
          key: `l${n}`,
          title: meta.title,
          pct,
          partsDone,
          partsTotal,
          state,
          startedAt: localStorage.getItem(startedK) || "",
          completedAt: localStorage.getItem(completedK) || "",
          timeSpentMin: getTimeSpentMin(n),
        };
      }

      function getQuizStat(n) {
        return {
          lastScore: Number(localStorage.getItem(uKey(`pc_lesson${n}_quiz_last_score`)) || 0),
          attempts: Number(localStorage.getItem(uKey(`pc_lesson${n}_quiz_attempts`)) || 0),
          failedAttempts: Number(localStorage.getItem(uKey(`pc_lesson${n}_quiz_failed_attempts`)) || 0),
          lastAttemptAt: localStorage.getItem(uKey(`pc_lesson${n}_quiz_last_attempt_at`)) || "",
        };
      }

      function getSubmissions() {
        const subs = [];
        [1, 4].forEach((n) => {
          const raw = localStorage.getItem(uKey(`pc_lesson${n}_submission`));
          const obj = safeJSON(raw, null);
          if (obj && obj.fileName) subs.push({ lesson: n, ...obj });
        });
        subs.sort((a, b) => String(b.submittedAt || "").localeCompare(String(a.submittedAt || "")));
        return subs;
      }

      function loadAdminStudents() {
        const raw = localStorage.getItem(ADMIN_STORE_KEY);
        const arr = safeJSON(raw, []);
        return Array.isArray(arr) ? arr : [];
      }

      function saveAdminStudents(list) {
        localStorage.setItem(ADMIN_STORE_KEY, JSON.stringify(list));
      }

      function getUserProfile() {
        const users = safeJSON(localStorage.getItem(USERS_STORE_KEY), []);
        return (users || []).find((u) => (u.email || "").toLowerCase() === __email) || null;
      }

      function ensureStudentRecord(students) {
        const u = getUserProfile();
        const id = (u?.studentId || "").trim() || `STU-${__email}`;
        const existingIdx = students.findIndex((s) => (s.email || "").toLowerCase() === __email || s.id === id);
        if (existingIdx !== -1) return existingIdx;

        students.push({
          id,
          name: u?.fullName || "Student",
          email: __email,
          course: u?.course || "—",
          year: u?.yearLevel || "—",
          lastActive: "—",
          status: "Active",
          progress: 0,
          lessons: [1, 2, 3, 4].map(computeLessonModel),
          quiz: { avgScore: 0, attempts: 0, failedAttempts: 0, lastAttemptAt: "" },
          assessment: { status: "Not started", submittedAt: "", reviewedAt: "", gradedAt: "", reviewer: "", feedback: "", rubric: { clarity: 0, audience: 0, tone: 0, organization: 0, grammar: 0, purpose: 0 } },
        });
        return students.length - 1;
      }

      function syncToAdminDashboard() {
        touchLastActive();

        const students = loadAdminStudents();
        const idx = ensureStudentRecord(students);
        const u = getUserProfile();
        const s = students[idx];

        s.name = u?.fullName || s.name || "Student";
        s.email = __email;
        s.id = (u?.studentId || s.id || `STU-${__email}`).trim();
        s.course = u?.course || s.course || "—";
        s.year = u?.yearLevel || s.year || "—";

        const lastTs = localStorage.getItem(uKey("pc_last_active_ts"));
        s.lastActive = relTimeFromTs(lastTs);
        const days = Math.floor((Date.now() - Number(lastTs || 0)) / (24 * 60 * 60 * 1000));
        s.status = days <= 7 ? "Active" : "Inactive";

        s.lessons = [1, 2, 3, 4].map(computeLessonModel);
        s.progress = Math.round(s.lessons.reduce((a, l) => a + (l.pct || 0), 0) / 4);

        const q2 = getQuizStat(2);
        const q3 = getQuizStat(3);
        const scores = [q2.lastScore, q3.lastScore].filter((x) => Number(x) > 0);
        const avgScore = scores.length ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
        s.quiz = {
          avgScore,
          attempts: (q2.attempts || 0) + (q3.attempts || 0),
          failedAttempts: (q2.failedAttempts || 0) + (q3.failedAttempts || 0),
          lastAttemptAt: [q2.lastAttemptAt, q3.lastAttemptAt].filter(Boolean).sort().slice(-1)[0] || "",
        };

        const subs = getSubmissions();
        s.assessment = s.assessment || { status: "Not started" };
        s.assessment.submissions = subs;
        if (subs.length) {
          const st = s.assessment.status || "Not started";
          if (st === "Not started") s.assessment.status = "Submitted";
          if (!s.assessment.submittedAt) s.assessment.submittedAt = subs[0].submittedAt || new Date().toISOString();
        }

        saveAdminStudents(students);
      }

      (function trackTime() {
        const enterAt = Date.now();
        function commit() {
          const delta = Date.now() - enterAt;
          const k = uKey(`pc_lesson${LESSON_NO}_time_spent_ms`);
          const prev = Number(localStorage.getItem(k) || 0);
          localStorage.setItem(k, String(prev + Math.max(0, delta)));
        }
        window.addEventListener("beforeunload", () => {
          commit();
          syncToAdminDashboard();
        });
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "hidden") {
            commit();
            syncToAdminDashboard();
          }
        });
      })();

      // Initial sync on load
      syncToAdminDashboard();

      const parts = [
        {
          title: "Part 1 — Lesson/Module",
          subtitle: "Role of social media, responsible use, and tech-based communication strategies.",
          type: "content",
          html: `
            <div class="rounded-2xl overflow-hidden ring-1 ring-black/5">
              <div class="aspect-video bg-black">
                <iframe class="w-full h-full"
                  src="https://www.youtube.com/embed/8S0FDjFBj8o"
                  title="Lesson Video (Fallback)"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen></iframe>
              </div>
            </div>

            <div class="prose max-w-none prose-slate">
              <p>
                New media and technology tools have transformed communication into something instant, global, and highly interactive.
                Platforms like Facebook, YouTube, TikTok, Instagram, and messaging apps support collaboration, tutorials, and learning communities.
              </p>

              <h3>Social media in technical fields</h3>
              <ul>
                <li>YouTube/TikTok tutorials for troubleshooting, safety practices, demonstrations</li>
                <li>Online groups/communities for exchanging solutions, diagrams, and best practices</li>
                <li>Industry updates and professional networking via platforms (e.g., LinkedIn, X)</li>
              </ul>

              <h3>Responsible use</h3>
              <p>
                Responsible social media use protects professionalism and credibility. Think before posting, avoid harassment, verify information,
                and remember digital footprints can affect employment opportunities.
              </p>

              <h3>Tech-based communication strategies</h3>
              <ul>
                <li>Keep it simple and emphasize key ideas</li>
                <li>Use visuals/videos for what is hard to explain with words</li>
                <li>Maintain coherent design and readable text</li>
              </ul>
            </div>
          `,
        },
        {
          title: "Part 2 — Assessment (File Submission)",
          subtitle: "Submit an infographic output (prototype file upload).",
          type: "upload",
          html: `
            <div class="rounded-2xl bg-slate-50 p-5 ring-1 ring-black/5">
              <h3 class="text-lg font-extrabold text-slate-900">Assessment Task</h3>
              <p class="mt-2 text-sm text-slate-600">
                Choose <strong>2 social media platforms</strong> (e.g., TikTok, YouTube, Facebook, X) and explain how they are used in your chosen field for:
                <strong>Collaboration</strong>, <strong>Tutorials</strong>, and <strong>Industry updates</strong>. Present your explanation as an <strong>infographic</strong>.
              </p>

              <div class="mt-5">
                <label class="block text-sm font-semibold text-slate-800">Upload your infographic file</label>
                <input id="fileInput" type="file" class="mt-2 block w-full text-sm file:mr-4 file:rounded-xl file:border-0 file:bg-brand-600 file:px-4 file:py-2 file:text-white file:font-semibold hover:file:bg-brand-700" />
                <button id="submitFileBtn" class="mt-3 rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800">
                  Submit File
                </button>
                <p id="fileStatus" class="mt-2 text-xs text-slate-600"></p>
              </div>
            </div>
          `,
        },
      ];

      const partsList = document.getElementById("partsList");
      const partTitle = document.getElementById("partTitle");
      const partSubtitle = document.getElementById("partSubtitle");
      const partBody = document.getElementById("partBody");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const completeBtn = document.getElementById("completeBtn");
      const progressText = document.getElementById("progressText");
      const progressBar = document.getElementById("progressBar");
      const statusPill = document.getElementById("statusPill");

      let activePart = 0;

      function initDefaults() {
        if (localStorage.getItem(LS.progress) === null) localStorage.setItem(LS.progress, "0");
        if (localStorage.getItem(LS.complete) === null) localStorage.setItem(LS.complete, "false");
        parts.forEach((_, i) => {
          const key = LS.partDone(i + 1);
          if (localStorage.getItem(key) === null) localStorage.setItem(key, "false");
        });
      }

      function isDone(partIndex1) {
        return localStorage.getItem(LS.partDone(partIndex1)) === "true";
      }

      function setDone(partIndex1, val) {
        localStorage.setItem(LS.partDone(partIndex1), val ? "true" : "false");
      }

      function computeAndSaveProgress() {
        const doneCount = parts.reduce((acc, _, i) => acc + (isDone(i + 1) ? 1 : 0), 0);
        const pct = Math.round((doneCount / parts.length) * 100);
        localStorage.setItem(LS.progress, String(pct));
        if (pct === 100) localStorage.setItem(LS.complete, "true");
        else localStorage.setItem(LS.complete, "false");
        // Keep admin dashboard in sync
        syncToAdminDashboard();
        return pct;
      }

      function renderProgress() {
        const pct = computeAndSaveProgress();
        progressText.textContent = `${pct}%`;
        progressBar.style.width = `${pct}%`;
      }

      function pill(done) {
        if (done) {
          statusPill.textContent = "Completed";
          statusPill.className = "inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-brand-50 text-brand-800 ring-1 ring-black/5";
        } else {
          statusPill.textContent = "Not completed";
          statusPill.className = "inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-slate-100 text-slate-700 ring-1 ring-black/5";
        }
      }

      function renderSidebar() {
        partsList.innerHTML = "";
        parts.forEach((p, idx) => {
          const done = isDone(idx + 1);
          const isActive = idx === activePart;

          const btn = document.createElement("button");
          btn.className =
            "w-full flex items-center justify-between gap-3 rounded-2xl px-4 py-3 text-left ring-1 ring-black/5 transition " +
            (isActive ? "bg-brand-600 text-white" : "bg-slate-50 hover:bg-slate-100 text-slate-900");

          btn.innerHTML = `
            <span class="text-sm font-semibold">${p.title}</span>
            <span class="text-xs font-bold ${isActive ? "text-white" : "text-brand-700"}">${done ? "✓" : ""}</span>
          `;

          btn.addEventListener("click", () => { activePart = idx; render(); });
          partsList.appendChild(btn);
        });
      }

      function wireUpload() {
        const submitFileBtn = document.getElementById("submitFileBtn");
        const fileInput = document.getElementById("fileInput");
        const fileStatus = document.getElementById("fileStatus");

        const savedName = localStorage.getItem(LS.assessmentFile);
        if (savedName) fileStatus.textContent = `Last submitted: ${savedName}`;

        submitFileBtn?.addEventListener("click", () => {
          if (!fileInput?.files?.length) {
            fileStatus.textContent = "Please choose a file first.";
            fileStatus.className = "mt-2 text-xs text-red-600";
            return;
          }
          const name = fileInput.files[0].name;
          const submission = {
            fileName: name,
            size: Number(fileInput.files[0].size || 0),
            submittedAt: new Date().toISOString(),
          };
          localStorage.setItem(LS.assessmentFile, name);
          localStorage.setItem(uKey(`pc_lesson${LESSON_NO}_submission`), JSON.stringify(submission));
          fileStatus.textContent = `Submitted: ${name}`;
          fileStatus.className = "mt-2 text-xs text-brand-800";

          setDone(activePart + 1, true);
          renderProgress();
          renderSidebar();
          pill(true);

          syncToAdminDashboard();
        });
      }

      function renderPart() {
        const p = parts[activePart];
        partTitle.textContent = p.title;
        partSubtitle.textContent = p.subtitle;
        partBody.innerHTML = p.html;

        pill(isDone(activePart + 1));

        prevBtn.disabled = activePart === 0;
        nextBtn.disabled = activePart === parts.length - 1;
        prevBtn.classList.toggle("opacity-50", prevBtn.disabled);
        prevBtn.classList.toggle("cursor-not-allowed", prevBtn.disabled);
        nextBtn.classList.toggle("opacity-50", nextBtn.disabled);
        nextBtn.classList.toggle("cursor-not-allowed", nextBtn.disabled);

        if (p.type === "upload") wireUpload();
      }

      function render() {
        renderSidebar();
        renderPart();
        renderProgress();
      }

      prevBtn.addEventListener("click", () => { if (activePart > 0) activePart--; render(); });
      nextBtn.addEventListener("click", () => { if (activePart < parts.length - 1) activePart++; render(); });
      completeBtn.addEventListener("click", () => { setDone(activePart + 1, true); render(); });

      initDefaults();
      render();
    </script>
  </body>
</html>
