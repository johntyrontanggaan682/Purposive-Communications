<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lesson 3 | Evaluating Messages and Images</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: "#E7F7F5",
                100: "#CFF0EC",
                200: "#9FE1D9",
                300: "#6ED2C6",
                400: "#3EC3B3",
                500: "#13A89A",
                600: "#0F877B",
                700: "#0B665C",
                800: "#07453E",
                900: "#032420",
              },
            },
            boxShadow: { soft: "0 10px 30px rgba(0,0,0,0.10)" },
          },
        },
      };
    </script>
    <style>
      .page-bg {
        background: radial-gradient(1200px 500px at 10% -10%, rgba(19, 168, 154, 0.12), transparent 55%),
          radial-gradient(900px 450px at 100% 0%, rgba(19, 168, 154, 0.10), transparent 50%),
          #fff;
      }

      /* Simple modal animation (same feel as index/profile) */
      .fade-in { animation: fadeIn .18s ease-out; }
      .scale-in { animation: scaleIn .18s ease-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes scaleIn { from { transform: translateY(8px) scale(.98); } to { transform: translateY(0) scale(1); } }

      .qblock { white-space: pre-wrap; }
    </style>
  </head>

  <body class="page-bg text-slate-800">
    <!-- NAVBAR ✅ EXACT SAME as lessons.html -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-100">
      <nav class="mx-auto flex max-w-7xl items-center justify-between px-4 py-4 sm:px-6 lg:px-8">
        <!-- Brand -->
        <a href="index.html" class="flex items-center gap-3">
          <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-brand-50 ring-1 ring-black/5">
            <svg viewBox="0 0 24 24" class="h-6 w-6 text-brand-700" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 7l8-4 8 4v10l-8 4-8-4V7z"></path>
              <path d="M8 11l2 2 5-5"></path>
            </svg>
          </div>
          <span class="text-lg font-semibold tracking-tight text-slate-900">Purposive Communication</span>
        </a>

        <!-- Desktop Links + Login/User Dropdown -->
        <div class="hidden items-center gap-8 md:flex">
          <a href="index.html" class="text-sm font-medium text-slate-700 hover:text-brand-700">Home</a>
          <a href="lessons.html" class="text-sm font-semibold text-brand-700">Lessons</a>

          <!-- Login (GUEST ONLY) -->
          <a
            href="login.html"
            id="openLoginBtn"
            class="auth-guest hidden rounded-xl bg-brand-500 px-5 py-2.5 text-sm font-semibold text-white shadow-soft hover:bg-brand-600"
            >Login</a
          >

          <!-- User dropdown (LOGGED IN ONLY) -->
          <div class="auth-user hidden relative">
            <button
              id="userMenuBtn"
              type="button"
              class="inline-flex items-center gap-3 rounded-2xl bg-white px-2 py-1.5 ring-1 ring-black/5 shadow-sm hover:bg-slate-50 hover:shadow-soft transition"
              aria-haspopup="menu"
              aria-expanded="false"
            >
              <div
                id="navAvatar"
                class="h-9 w-9 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center text-slate-700 font-extrabold"
              >
                U
              </div>
              <span id="navName" class="text-sm font-semibold text-slate-900">Student</span>
              <svg
                id="navCaret"
                class="h-4 w-4 text-slate-500 transition-transform"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
              </svg>
            </button>

            <!-- Dropdown panel -->
            <div
              id="userDropdown"
              class="absolute right-[-10px] mt-3 hidden w-[290px] overflow-hidden rounded-3xl bg-white shadow-soft ring-1 ring-black/10"
            >
              <div class="p-3">
                <div class="rounded-2xl bg-brand-50 p-3 ring-1 ring-brand-100">
                  <div class="flex items-start gap-3">
                    <div
                      id="ddAvatar"
                      class="h-11 w-11 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center text-slate-700 font-extrabold text-lg"
                    ></div>
                    <div class="min-w-0">
                      <p id="ddName" class="truncate text-sm font-extrabold text-slate-900">Student</p>
                      <p class="text-xs font-semibold text-slate-500">Student</p>
                    </div>
                  </div>
                </div>

                <div class="mt-3 space-y-2 text-sm">
                  <div class="flex items-center gap-3 rounded-xl bg-white px-3 py-2 ring-1 ring-black/5">
                    <svg class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M22 6l-10 7L2 6" />
                    </svg>
                    <span id="ddEmail" class="truncate text-slate-700">email@example.com</span>
                  </div>

                  <div class="flex items-center gap-3 rounded-xl bg-white px-3 py-2 ring-1 ring-black/5">
                    <svg class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="5" width="18" height="14" rx="2" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 15h4" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 9h10" />
                    </svg>
                    <span class="text-slate-700">ID: <span id="ddId" class="font-semibold text-slate-800">—</span></span>
                  </div>
                </div>

                <div class="mt-3 grid grid-cols-2 gap-2">
                  <a
                    href="profile.html"
                    class="inline-flex items-center justify-center rounded-2xl bg-brand-800 px-4 py-2.5 text-sm font-semibold text-white hover:bg-brand-900 transition"
                  >
                    View profile
                  </a>
                  <button
                    id="signOutBtn"
                    type="button"
                    class="inline-flex items-center justify-center rounded-2xl bg-slate-100 px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-200 transition"
                  >
                    Sign out
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile -->
        <button
          id="menuBtn"
          class="inline-flex items-center justify-center rounded-xl bg-slate-50 p-2 text-slate-800 ring-1 ring-black/5 hover:bg-slate-100 md:hidden"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </nav>

      <!-- Mobile Menu -->
      <div id="mobileMenu" class="mx-auto hidden max-w-7xl px-4 pb-4 sm:px-6 lg:px-8 md:hidden">
        <div class="rounded-2xl bg-white p-4 shadow-soft ring-1 ring-black/5">
          <div class="flex flex-col gap-2">
            <a href="index.html" class="rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">Home</a>
            <a href="lessons.html" class="rounded-xl px-3 py-2 text-sm font-semibold text-brand-700 bg-brand-50">Lessons</a>
            <a href="profile.html" class="rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">Profile</a>

            <!-- Login (GUEST ONLY) -->
            <a
              href="login.html"
              id="openLoginMobile"
              class="auth-guest hidden mt-2 rounded-xl bg-brand-500 px-4 py-2.5 text-center text-sm font-semibold text-white hover:bg-brand-600"
              >Login</a
            >

            <!-- Logged-in block (MOBILE ONLY) -->
            <div class="auth-user hidden mt-2 rounded-2xl bg-white ring-1 ring-black/5 p-3">
              <div class="flex items-center gap-3">
                <div
                  id="mNavAvatar"
                  class="h-10 w-10 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center font-extrabold text-slate-700"
                >
                  U
                </div>
                <div class="min-w-0">
                  <p id="mNavName" class="truncate text-sm font-extrabold text-slate-900">Student</p>
                  <p id="mNavEmail" class="truncate text-xs font-semibold text-slate-500">email@example.com</p>
                </div>
              </div>
              <div class="mt-3 grid grid-cols-2 gap-2">
                <a
                  href="profile.html"
                  class="rounded-xl bg-brand-800 px-3 py-2 text-center text-sm font-semibold text-white hover:bg-brand-900"
                  >View profile</a
                >
                <button id="mSignOutBtn" class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200">
                  Sign out
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- HERO -->
    <!-- HERO -->
<section class="bg-brand-700">
  <div class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <div>
        <p class="text-white/80 text-sm font-semibold">Lesson 3</p>
        <h1 class="mt-1 text-3xl sm:text-4xl font-extrabold tracking-tight text-white">
          Evaluating Messages and Images of Different Text Types
        </h1>
        <p class="mt-3 max-w-3xl text-white/85">
          Parts: World Englishes in Technical Work • Balancing Identity and Intelligibility • Multimodality in Technical Communication • Evaluating the Effectiveness of a Message • Tasks 1–4 (MCQ + File Submission)
        </p>
      </div>

      <div class="w-full md:w-[340px]">
        <div class="rounded-2xl bg-white/10 ring-1 ring-white/15 p-4">
          <div class="flex items-center justify-between text-sm text-white/90">
            <span class="font-semibold">Lesson Progress</span>
            <span id="progressText" class="font-bold">0%</span>
          </div>
          <div class="mt-3 h-2.5 w-full rounded-full bg-white/20">
            <div id="progressBar" class="h-2.5 w-0 rounded-full bg-white transition-all"></div>
          </div>
          <p class="mt-2 text-xs text-white/70">Assessments save scores when submitted.</p>
        </div>
      </div>
    </div>
  </div>
</section>

    <main class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8">
      <div class="grid gap-8 lg:grid-cols-12">
        <aside class="lg:col-span-3">
          <div class="rounded-3xl bg-white shadow-soft ring-1 ring-black/5 p-5 sticky top-24">
            <h2 class="text-sm font-extrabold text-slate-900">Lesson Parts</h2>
            <div id="partsList" class="mt-4 space-y-2"></div>
          </div>
        </aside>

        <section class="lg:col-span-9">
          <div class="rounded-3xl bg-white shadow-soft ring-1 ring-black/5 p-6 sm:p-8">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 id="partTitle" class="text-2xl font-extrabold text-slate-900"></h2>
                <p id="partSubtitle" class="mt-2 text-sm text-slate-600"></p>
              </div>
              <span id="statusPill" class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ring-1 ring-black/5">
                Not completed
              </span>
            </div>

            <div id="partBody" class="mt-6 space-y-6"></div>

            <div class="mt-8 flex flex-col-reverse gap-3 sm:flex-row sm:items-center sm:justify-between">
              <button id="prevBtn" class="rounded-xl bg-slate-100 px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-200 ring-1 ring-black/5">
                ← Previous
              </button>

              <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-end">
                <button id="completeBtn" class="rounded-xl bg-brand-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-brand-700 ring-1 ring-black/5">
                  Mark Part as Completed
                </button>
                <button id="nextBtn" class="rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800 ring-1 ring-black/5">
                  Next →
                </button>
              </div>
            </div>
          </div>

          <p class="mt-4 text-xs text-slate-500">Passing score for each assessment is <strong>70%</strong> to mark it complete.</p>
          <p class="mt-1 text-xs text-slate-500">Note: Task submissions are stored in Firestore as a filename only (no upload storage yet).</p>
        </section>
      </div>
    </main>

    <!-- ✅ SIGN OUT CONFIRM MODAL (same as index.html) -->
    <div id="signOutModal" class="fixed inset-0 z-[95] hidden">
      <div id="signOutBackdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm fade-in"></div>

      <div class="relative mx-auto flex min-h-full max-w-md items-center justify-center px-4 py-10">
        <div class="w-full rounded-3xl bg-white shadow-soft ring-1 ring-black/10 scale-in">
          <div class="p-5 sm:p-6 text-center">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-2xl bg-brand-50 ring-1 ring-black/5">
              <svg viewBox="0 0 24 24" class="h-6 w-6 text-brand-700" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v5" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16h.01" />
              </svg>
            </div>

            <h3 class="mt-3 text-base font-extrabold text-slate-900">Are you sure you want to sign out?</h3>

            <div class="mt-5 grid grid-cols-2 gap-3">
              <button id="signOutNo" type="button"
                class="w-full rounded-xl bg-slate-100 px-5 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-200 ring-1 ring-black/5">
                No
              </button>

              <button id="signOutYes" type="button"
                class="w-full rounded-xl bg-brand-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-brand-700 ring-1 ring-black/5">
                Yes
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ Firebase only (NO localStorage) -->
    <script type="module">
      import { auth, db } from "./firebase.js";
      import {
        onAuthStateChanged,
        signOut as firebaseSignOut,
        setPersistence,
        browserSessionPersistence
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

      import {
        doc,
        getDoc,
        setDoc,
      updateDoc
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

      // ✅ Force Firebase auth to NOT use localStorage (session only)
      try { await setPersistence(auth, browserSessionPersistence); } catch (_) {}

      // ===== Auth dropdown (Firebase) =====
      const guestEls = Array.from(document.querySelectorAll(".auth-guest"));
      const userEls = Array.from(document.querySelectorAll(".auth-user"));

      const userMenuBtn = document.getElementById("userMenuBtn");
      const userDropdown = document.getElementById("userDropdown");
      const navCaret = document.getElementById("navCaret");

      const navName = document.getElementById("navName");
      const navAvatar = document.getElementById("navAvatar");

      const ddName = document.getElementById("ddName");
      const ddEmail = document.getElementById("ddEmail");
      const ddId = document.getElementById("ddId");
      const ddAvatar = document.getElementById("ddAvatar");

      const mNavName = document.getElementById("mNavName");
      const mNavEmail = document.getElementById("mNavEmail");
      const mNavAvatar = document.getElementById("mNavAvatar");

      const signOutBtn = document.getElementById("signOutBtn");
      const mSignOutBtn = document.getElementById("mSignOutBtn");

      let __currentUser = null;
      let __profile = null;

      function isLoggedIn() { return !!__currentUser; }

      function getInitials(nameOrEmail) {
        const n = (nameOrEmail || "").trim();
        if (!n) return "U";
        const parts = n.split(/\s+/).filter(Boolean);
        if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        return (parts[0][0] || "U").toUpperCase();
      }

      function setAvatarEl(el, text) {
        if (!el) return;
        el.textContent = text || "U";
      }

      function closeUserDropdown() {
        if (!userDropdown || !userMenuBtn) return;
        userDropdown.classList.add("hidden");
        userMenuBtn.setAttribute("aria-expanded", "false");
        navCaret?.classList.remove("rotate-180");
      }

      function openUserDropdown() {
        if (!userDropdown || !userMenuBtn) return;
        userDropdown.classList.remove("hidden");
        userMenuBtn.setAttribute("aria-expanded", "true");
        navCaret?.classList.add("rotate-180");
      }

      function toggleUserDropdown() {
        if (!userDropdown) return;
        const isOpen = !userDropdown.classList.contains("hidden");
        if (isOpen) closeUserDropdown();
        else openUserDropdown();
      }

      userMenuBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        toggleUserDropdown();
      });

      document.addEventListener("click", (e) => {
        if (!userDropdown || userDropdown.classList.contains("hidden")) return;
        const wrapper = userMenuBtn?.parentElement; // .auth-user
        if (wrapper && e.target instanceof Node && !wrapper.contains(e.target)) closeUserDropdown();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeUserDropdown();
      });

    function maybeRedirectLocked(p) {
      const role = String(p?.role || "student").toLowerCase().trim();
      if (role === "student" && p?.locked === true) {
        const here = String(window.location.href || "").toLowerCase();
        if (!here.endsWith("locked.html")) {
          window.location.href = "locked.html";
          return true;
        }
      }
      return false;
    }

    async function loadProfile(uid) {
      try {
        const snap = await getDoc(doc(db, "users", uid));
        const p = snap.exists() ? (snap.data() || {}) : {};
        maybeRedirectLocked(p);
        return p;
      } catch (_) {
        return {};
      }
    }


      function applyAuthUI() {
        const loggedIn = isLoggedIn();

        guestEls.forEach(el => el.classList.toggle("hidden", loggedIn));
        userEls.forEach(el => el.classList.toggle("hidden", !loggedIn));

        if (!loggedIn) {
          closeUserDropdown();
          return;
        }

        const fullName = (__profile?.fullName || __currentUser?.displayName || "Student").trim() || "Student";
        const email = (__profile?.email || __currentUser?.email || "").trim();
        const studentId = (__profile?.studentId || "").trim();

        const avatarText = (__profile?.avatar?.type === "emoji" && __profile?.avatar?.value)
          ? __profile.avatar.value
          : getInitials(fullName || email);

        if (navName) navName.textContent = fullName;
        if (ddName) ddName.textContent = fullName;
        if (ddEmail) ddEmail.textContent = email;
        if (ddId) ddId.textContent = studentId ? studentId : "—";

        setAvatarEl(navAvatar, avatarText);
        setAvatarEl(ddAvatar, avatarText);

        if (mNavName) mNavName.textContent = fullName;
        if (mNavEmail) mNavEmail.textContent = email;
        setAvatarEl(mNavAvatar, avatarText);
      }

      // ===== Sign out confirm =====
      const signOutModal = document.getElementById("signOutModal");
      const signOutBackdrop = document.getElementById("signOutBackdrop");
      const signOutYes = document.getElementById("signOutYes");
      const signOutNo = document.getElementById("signOutNo");

      function openSignOutModal() {
        closeUserDropdown();
        signOutModal?.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      }
      function closeSignOutModal() {
        signOutModal?.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }

      signOutNo?.addEventListener("click", closeSignOutModal);
      signOutBackdrop?.addEventListener("click", closeSignOutModal);
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && signOutModal && !signOutModal.classList.contains("hidden")) closeSignOutModal();
      });

      async function doSignOut() {
        try { await firebaseSignOut(auth); } catch (_) {}
        __currentUser = null;
        __profile = null;
        closeUserDropdown();
        applyAuthUI();
        closeSignOutModal();
        window.location.href = "index.html";
      }

      window.__pcSignOut = doSignOut;

      signOutBtn?.addEventListener("click", (e) => { e.preventDefault(); openSignOutModal(); });
      mSignOutBtn?.addEventListener("click", (e) => { e.preventDefault(); openSignOutModal(); });

      signOutYes?.addEventListener("click", async () => {
        closeSignOutModal();
        await doSignOut();
      });

      // ===== Lesson 3 script =====
const LESSON_NO = 3;
const PASSING = 70;

// -----------------------------
// Task 1 (MCQ) — World Englishes Meanings (30 items)
// -----------------------------
const worldEnglishesQuiz = [
  { qHtml: `1. Indian English\n“Kindly revert with the machine report.”`, options: ["A. Please return the machine report physically","B. Please reply with the machine report","C. Please cancel the machine report"], answer: 1 },
  { qHtml: `2. Singapore English\n“Can finish by today or not?”`, options: ["A. Do you want to finish today?","B. Can you repeat the task?","C. Is it possible to finish today?"], answer: 2 },
  { qHtml: `3. Filipino English\n“Open the fan in the workshop.”`, options: ["A. Fix the fan in the workshop","B. Turn on the fan in the workshop","C. Remove the fan cover"], answer: 1 },
  { qHtml: `4. British English\n“Take the lift to the factory floor.”`, options: ["A. Take the elevator to the factory floor","B. Take the stairs to the factory floor","C. Take the escalator to the factory floor"], answer: 0 },
  { qHtml: `5. American English\n“Put the trash in the garbage can near the assembly line.”`, options: ["A. Put the food in the fridge","B. Put the tools in the box","C. Put the waste in the bin near the assembly line"], answer: 2 },
  { qHtml: `6. Indian English\n“Do the needful with the safety checklist.”`, options: ["A. Ignore the checklist","B. Do whatever you want with the checklist","C. Take necessary action with the safety checklist"], answer: 2 },
  { qHtml: `7. Singapore English\n“Don’t be so kiasu about overtime.”`, options: ["A. Don’t be lazy about overtime","B. Don’t be late for overtime","C. Don’t be overly afraid of missing overtime benefits"], answer: 2 },
  { qHtml: `8. Filipino English\n“Take a picture of the machine for remembrance.”`, options: ["A. Take a photo for ID purposes","B. Take a photo as a keepsake","C. Take a photo for documentation only"], answer: 1 },
  { qHtml: `9. British English\n“Put the rubbish in the bin outside the workshop.”`, options: ["A. Store the food","B. Throw the trash away","C. Keep the tools"], answer: 1 },
  { qHtml: `10. American English\n“Check the faucet in the factory washroom.”`, options: ["A. Check the pipe in the washroom","B. Check the tap in the washroom","C. Check the sink in the washroom"], answer: 1 },
  { qHtml: `11. Indian English\n“We need to prepone the factory meeting.”`, options: ["A. Cancel the meeting","B. Move the meeting later","C. Move the meeting earlier"], answer: 2 },
  { qHtml: `12. Singapore English\n“He’s blur like sotong during machine training.”`, options: ["A. He’s happy during training","B. He’s confused like a squid during training","C. He’s angry during training"], answer: 1 },
  { qHtml: `13. Filipino English\n“I’ll go to the comfort room near the production area.”`, options: ["A. I’ll go to the lounge near the production area","B. I’ll go to the restroom near the production area","C. I’ll go to the bedroom near the production area"], answer: 1 },
  { qHtml: `14. British English\n“He’s in hospital after the factory accident.”`, options: ["A. He’s visiting the hospital","B. He’s admitted to the hospital","C. He’s working at the hospital"], answer: 1 },
  { qHtml: `15. American English\n“He’s in the hospital after the factory accident.”`, options: ["A. He’s admitted to the hospital","B. He’s visiting the hospital","C. He’s working at the hospital"], answer: 0 },
  { qHtml: `16. Indian English\n“The supervisor is out of station.”`, options: ["A. Out of service","B. Out of town","C. Out of the office"], answer: 1 },
  { qHtml: `17. Singapore English\n“Don’t anyhow operate the machine.”`, options: ["A. Don’t operate the machine quickly","B. Don’t operate the machine carelessly","C. Don’t operate the machine at all"], answer: 1 },
  { qHtml: `18. Filipino English\n“I’ll go to the province after my factory shift.”`, options: ["A. I’ll go abroad","B. I’ll go to the countryside","C. I’ll go to the city"], answer: 1 },
  { qHtml: `19. British English\n“He lives in a flat near the industrial park.”`, options: ["A. He lives in a dormitory near the industrial park","B. He lives in a house near the industrial park","C. He lives in an apartment near the industrial park"], answer: 2 },
  { qHtml: `20. American English\n“He lives in an apartment near the industrial park.”`, options: ["A. He lives in a flat near the industrial park","B. He lives in a house near the industrial park","C. He lives in a dormitory near the industrial park"], answer: 0 },
  { qHtml: `21. Indian English\n“He passed out from engineering college.”`, options: ["A. He fainted in engineering college","B. He graduated from engineering college","C. He dropped out of engineering college"], answer: 1 },
  { qHtml: `22. Singapore English\n“Don’t play play with factory safety.”`, options: ["A. Don’t joke about safety","B. Don’t take safety lightly","C. Don’t play games in the factory"], answer: 1 },
  { qHtml: `23. Filipino English\n“I’ll just fall in line at the canteen.”`, options: ["A. I’ll sit down at the canteen","B. I’ll queue up at the canteen","C. I’ll wait outside the canteen"], answer: 1 },
  { qHtml: `24. British English\n“He’s at university studying industrial design.”`, options: ["A. He’s visiting the university","B. He’s studying at university","C. He’s working at the university"], answer: 1 },
  { qHtml: `25. American English\n“He’s in college studying industrial design.”`, options: ["A. He’s studying at college","B. He’s visiting the college","C. He’s working at the college"], answer: 0 },
  { qHtml: `26. Indian English\n“My cousin brother works in the factory.”`, options: ["A. My friend works in the factory","B. My male cousin works in the factory","C. My brother works in the factory"], answer: 1 },
  { qHtml: `27. Singapore English\n“Don’t be kaypoh about the factory project.”`, options: ["A. Don’t be lazy about the project","B. Don’t be nosy about the project","C. Don’t be late for the project"], answer: 1 },
  { qHtml: `28. Filipino English\n“I’ll go to the CR near the workshop.”`, options: ["A. I’ll go to the restroom near the workshop","B. I’ll go to the classroom near the workshop","C. I’ll go to the cafeteria near the workshop"], answer: 0 },
  { qHtml: `29. British English\n“He’s buying petrol for the factory generator.”`, options: ["A. He’s buying diesel for the generator","B. He’s buying kerosene for the generator","C. He’s buying gasoline for the generator"], answer: 2 },
  { qHtml: `30. American English\n“He’s buying gas for the factory generator.”`, options: ["A. He’s buying cooking gas for the generator","B. He’s buying kerosene for the generator","C. He’s buying gasoline for the generator"], answer: 2 },
];

// -----------------------------
// Task 2 (MCQ) — Multimodality Choices (15 items)
// -----------------------------
const multimodalityQuiz = [
  { q: "1. Safety Rules in a Laboratory", options: ["Text only","Text + Images","Audio only","Video only"], answer: 1 },
  { q: "2. Demonstrating Fire Extinguisher Use", options: ["Text only","Audio instructions","Video demonstration","Images only"], answer: 2 },
  { q: "3. Food Service Guidelines for New Staff", options: ["Text + Images","Audio only","Video only","Text only"], answer: 0 },
  { q: "4. Machine Troubleshooting (Step-by-Step)", options: ["Text only","Text + Images","Audio only","Video only"], answer: 1 },
  { q: "5. Emergency Evacuation Drill", options: ["Text only","Audio announcement","Video simulation","Images only"], answer: 2 },
  { q: "6. Explaining Workplace Dress Code", options: ["Text only","Text + Images","Audio only","Video only"], answer: 1 },
  { q: "7. Teaching Knife Safety in Culinary Class", options: ["Text only","Images only","Video demonstration","Audio only"], answer: 2 },
  { q: "8. Introducing New Software Features", options: ["Text only","Text + Images","Audio only","Video tutorial"], answer: 1 },
  { q: "9. First Aid Procedures (CPR)", options: ["Text only","Audio instructions","Video demonstration","Images only"], answer: 2 },
  { q: "10. Explaining Food Storage Guidelines", options: ["Text only","Text + Images","Audio only","Video only"], answer: 1 },
  { q: "11. Assembly Instructions for Furniture", options: ["Text only","Text + Images","Audio only","Video only"], answer: 1 },
  { q: "12. Demonstrating Proper Handwashing", options: ["Text only","Images only","Video demonstration","Audio only"], answer: 2 },
  { q: "13. Orientation for New Factory Workers", options: ["Text only","Audio only","Video + Images","Text only"], answer: 2 },
  { q: "14. Explaining Electrical Safety Precautions", options: ["Text only","Text + Images","Audio only","Video only"], answer: 1 },
  { q: "15. Customer Service Training (Role Play)", options: ["Text only","Audio only","Video demonstration","Images only"], answer: 2 },
];

// -----------------------------
// Task 4 (MCQ + Justification) — Evaluating Messages (10 items)
// -----------------------------
const effectivenessQuiz = [
  { q: "1. “Check the machine regularly.”", options: ["A. “Inspect the hydraulic press every 2 hours for oil leaks and unusual noise.”","B. “Look at the machine sometimes.”","C. “Check it when you feel like it.”"], answer: 0 },
  { q: "2. “Be careful with wires.”", options: ["A. “Turn off the main switch before touching any wires to avoid electric shock.”","B. “Handle wires carefully.”","C. “Don’t touch wires.”"], answer: 0 },
  { q: "3. “Fix the car properly.”", options: ["A. “Tighten all bolts to manufacturer torque specifications before releasing the vehicle.”","B. “Do a good job.”","C. “Repair it fast.”"], answer: 0 },
  { q: "4. “Make sure the site is safe.”", options: ["A. “Secure scaffolding, wear helmets, and check hazard signs before starting work.”","B. “Be safe.”","C. “Check the site.”"], answer: 0 },
  { q: "5. “Wash your hands.”", options: ["A. “Wash your hands with soap for 20 seconds before handling food.”","B. “Wash hands if you want.”","C. “Don’t forget hygiene.”"], answer: 0 },
  { q: "6. “Test the circuit.”", options: ["A. “Use a multimeter to test voltage and resistance before connecting the circuit.”","B. “Check the circuit sometimes.”","C. “Look at the wires.”"], answer: 0 },
  { q: "7. “Lubricate the parts.”", options: ["A. “Apply grease to all moving joints every 50 hours of operation.”","B. “Put oil when needed.”","C. “Grease it if you want.”"], answer: 0 },
  { q: "8. “Check the brakes.”", options: ["A. “Inspect brake pads weekly and replace them if thickness is below 3mm.”","B. “Look at the brakes.”","C. “Check brakes when noisy.”"], answer: 0 },
  { q: "9. “Follow safety rules.”", options: ["A. “Wear helmets, reflective vests, and safety boots before entering the construction site.”","B. “Be safe always.”","C. “Follow rules.”"], answer: 0 },
  { q: "10. “Keep food fresh.”", options: ["A. “Store perishable food at 4°C or below to maintain freshness.”","B. “Keep food nice.”","C. “Don’t let food spoil.”"], answer: 0 },
];

// Helpers
function uploadPartHtml(taskKey, taskTitle, taskBodyHtml) {
  return `
    <div class="rounded-2xl bg-slate-50 p-5 ring-1 ring-black/5">
      <h3 class="text-lg font-extrabold text-slate-900">${taskTitle}</h3>
      <div class="mt-3 space-y-3 text-sm text-slate-700">
        ${taskBodyHtml}
      </div>

      <div class="mt-5">
        <label class="block text-sm font-semibold text-slate-800">Upload your file</label>
        <input id="fileInput-${taskKey}" type="file" class="mt-2 block w-full text-sm file:mr-4 file:rounded-xl file:border-0 file:bg-brand-600 file:px-4 file:py-2 file:text-white file:font-semibold hover:file:bg-brand-700" />
        <button id="submitFileBtn-${taskKey}" class="mt-3 rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800">
          Submit File
        </button>
        <p id="fileStatus-${taskKey}" class="mt-2 text-xs text-slate-600"></p>
      </div>
    </div>
  `;
}

const parts = [
  {
    title: "Part 1 — World Englishes in Technical Work",
    subtitle: "Identify different varieties of World Englishes and why intelligibility matters in technical settings.",
    type: "content",
    html: `
      <div class="prose max-w-none prose-slate">
        <h3>Lesson 3: Evaluating Messages and Images of Different Text Types</h3>
        <h4>Learning Outcomes</h4>
        <ol>
          <li>Identify different varieties of World Englishes.</li>
          <li>Apply appropriate multimodal communication strategies (text, visuals, audio, video) to effectively present technical information in workplace scenarios.</li>
          <li>Evaluate the effectiveness of sample messages from technical contexts using the four qualities—simplicity, specificity, structure, and stickiness.</li>
        </ol>

        <h4>World Englishes</h4>
        <p>
          English today is not one uniform language. It has been shaped by cultures worldwide, creating regionally distinct varieties
          such as Indian English, West African English, Singapore English, and Filipino English.
        </p>
        <p>
          In technical workplaces, teams can be global. People may use different pronunciations, vocabulary, or sentence structures.
          These differences are not “mistakes” — they are features of local varieties. The key challenge is <strong>intelligibility</strong>:
          making sure messages are clear enough for others to understand to avoid errors, safety issues, or poor service.
        </p>

        <h4>Technical example</h4>
        <ul>
          <li>Indian English: “Kindly revert” = “Please reply”</li>
          <li>Singapore English: “Can or not?” = “Is it possible?”</li>
          <li>Filipino English: “Open the light” = “Turn on the light”</li>
        </ul>

        <p>
          Recognizing World Englishes builds flexibility, respect, and professionalism in multicultural technical environments.
        </p>
      </div>
    `
  },
  {
    title: "Part 2 — Balancing Identity and Intelligibility",
    subtitle: "Adjust English to your audience while respecting identity (Kirkpatrick’s extremes).",
    type: "content",
    html: `
      <div class="prose max-w-none prose-slate">
        <p>
          Local English expressions can create barriers to understanding across varieties (e.g., “Having here, or take away?” vs
          “Dine in, or take out?”). Kirkpatrick (2007) explains two extremes:
        </p>

        <ul>
          <li><strong>National/Regional Identity</strong> — using local variety to affirm culture (local terms may confuse outsiders).</li>
          <li><strong>Intelligibility</strong> — being understood worldwide (learning equivalents like “bin/trash can”, “lift/elevator”).</li>
        </ul>

        <p>
          Professionals often <strong>code-switch</strong> or adjust variety depending on the audience. The goal is balance: be clear,
          respectful, and flexible while maintaining identity.
        </p>

        <h4>When interpreting technical messages, ask:</h4>
        <ul>
          <li>What is the message?</li>
          <li>What is the purpose?</li>
          <li>How is it conveyed (text/diagram/sign)?</li>
          <li>Who is the target audience?</li>
          <li>What other ways can it be presented?</li>
        </ul>
      </div>
    `
  },
  {
    title: "Part 3 — Multimodality in Technical Communication",
    subtitle: "Combine two or more modes (text, images, audio, video, action) to improve clarity and engagement.",
    type: "content",
    html: `
      <div class="prose max-w-none prose-slate">
        <p>
          A message is <strong>multimodal</strong> when it uses two or more modes to create meaning (linguistic, visual, aural,
          somatic/body movement). In technical training, combining modes makes instructions clearer and more memorable.
        </p>

        <h4>Common multimodal outputs</h4>
        <ul>
          <li><strong>Paper-based</strong>: posters, brochures, comics (e.g., wiring safety poster).</li>
          <li><strong>Digital</strong>: slides, web pages, infographics, videos, tutorials.</li>
          <li><strong>Live</strong>: demonstrations, role-plays, seminars.</li>
          <li><strong>Transmedia</strong>: one concept across multiple platforms (comics + video + social posts).</li>
        </ul>

        <p>
          Multimodality is powered by <strong>semiotics</strong>—how symbols (icons, diagrams, color codes) are interpreted. Technical
          communication uses symbols constantly (circuit diagrams, safety icons, labels). The right combination boosts understanding.
        </p>
      </div>
    `
  },
  {
    title: "Part 4 — Evaluating the Effectiveness of a Message",
    subtitle: "Use the four qualities: simplicity, specificity, structure, and stickiness.",
    type: "content",
    html: `
      <div class="prose max-w-none prose-slate">
        <p>
          Effective technical messages prevent mistakes and improve safety and efficiency. Evaluate messages using four qualities:
        </p>
        <ul>
          <li><strong>Simplicity</strong> — remove unnecessary words; keep a clear purpose.</li>
          <li><strong>Specificity</strong> — use concrete, actionable details (avoid vague instructions).</li>
          <li><strong>Structure</strong> — organize ideas logically (intro → steps → reminder).</li>
          <li><strong>Stickiness</strong> — make it memorable (short slogans, strong cues).</li>
        </ul>

        <p>
          Before sending or posting a technical message, ask: Is my purpose clear? Are my words concrete? Do ideas flow logically?
          Will the message be remembered?
        </p>
      </div>
    `
  },

  // Tasks
  {
    title: "Task 1 — MQC (World Englishes Meanings)",
    subtitle: "Choose the correct meaning of each expression. Submit anytime — your score will be saved.",
    type: "quiz",
    quizTitle: "Task 1",
    quizSubtitle: "Read each labeled variety and choose the correct meaning.",
    data: worldEnglishesQuiz
  },
  {
    title: "Task 2 — MQC (Multimodal Communication Choices)",
    subtitle: "Select the best combination of modes to ensure clarity, accuracy, and engagement.",
    type: "quiz",
    quizTitle: "Task 2",
    quizSubtitle: "Choose the best communication mode(s) for each situation.",
    data: multimodalityQuiz
  },
  {
    title: "Task 3 — File Submission (Multimodal Output + Reflection)",
    subtitle: "Create a multimodal output and submit your file. Include a 5–7 sentence reflection.",
    type: "upload",
    taskKey: "task3",
    html: uploadPartHtml(
      "task3",
      "Task 3 — Multimodal Technical Communication Output",
      `
        <div class="rounded-xl bg-white p-4 ring-1 ring-black/5">
          <p class="font-semibold">Instructions</p>
          <p class="mt-2">
            Choose <strong>one</strong> scenario and create an appropriate output (poster, manual, audio recording, or video demonstration):
          </p>
          <ol class="mt-2 list-decimal pl-5 space-y-1">
            <li>Safety Rules in a Laboratory – Present essential safety guidelines for new students.</li>
            <li>Machine Troubleshooting Guide – Explain step-by-step how to fix a common technical issue.</li>
            <li>Food Service Guidelines – Show proper hygiene and service practices in a cafeteria or restaurant.</li>
            <li>Emergency Evacuation Drill – Demonstrate procedures for safe evacuation during emergencies.</li>
            <li>Customer Service Training – Model effective communication strategies for handling customer concerns.</li>
          </ol>

          <p class="mt-3 font-semibold">Include a short reflection (5–7 sentences)</p>
          <ul class="mt-1 list-disc pl-5">
            <li>Why you chose that mode.</li>
            <li>How it ensures clarity and engagement for the intended audience.</li>
          </ul>

          <p class="mt-3 text-xs text-slate-500">
            Note: Submission is stored in Firestore as a filename only (no file storage integration yet).
          </p>
        </div>
      `
    )
  },
  {
    title: "Task 4 — MQC with Justification (Message Effectiveness)",
    subtitle: "Choose the best revision option and justify why it is best (simplicity, specificity, structure, stickiness).",
    type: "quiz_justify",
    quizTitle: "Task 4",
    quizSubtitle: "Answer each item, then write a brief justification. Submit to save your score + justifications.",
    data: effectivenessQuiz
  }
];

// Elements
const partsList = document.getElementById("partsList");
const partTitle = document.getElementById("partTitle");
const partSubtitle = document.getElementById("partSubtitle");
const partBody = document.getElementById("partBody");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const completeBtn = document.getElementById("completeBtn");
const progressText = document.getElementById("progressText");
const progressBar = document.getElementById("progressBar");
const statusPill = document.getElementById("statusPill");

let activePart = 0;
let __lessonState = null;

function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

function lessonDocRef(uid) {
  return doc(db, "users", uid, "lessons", `lesson${LESSON_NO}`);
}
function progressDocRef(uid) {
  return doc(db, "users", uid, "progress", `lesson${LESSON_NO}`);
}

function userDocRef(uid) { return doc(db, "users", uid); }

async function upsertUserDocFields(uid, data) {
  const ref = userDocRef(uid);
  try {
    await updateDoc(ref, data);
  } catch (err) {
    try { await setDoc(ref, data, { merge: true }); }
    catch (err2) { console.warn("Firestore write failed (user doc fallback)", err2); }
  }
}

async function mustHaveLesson2Complete(uid) {
  try {
    const snap = await getDoc(doc(db, "users", uid, "progress", "lesson2"));
    const d = snap.exists() ? (snap.data() || {}) : {};
    return !!d.complete || (parseInt(d.progress || "0", 10) >= 100);
  } catch (_) {
    return false;
  }
}

const FILE_TASK_KEYS = ["task3"];
function emptyTaskFiles() { return { task3: "" }; }

function defaultLessonState() {
  return {
    partsDone: parts.map(() => false),
    quizAnswers: {},
    quizScores: {},
    quizJustifications: {},
    taskFiles: emptyTaskFiles(),
    assessmentFile: ""
  };
}

function normalizeQuizAnswers(raw) {
  const out = {};
  if (!raw || typeof raw !== "object") return out;

  const vals = Object.values(raw);
  const isNested = vals.some(v => v && typeof v === "object" && !Array.isArray(v));
  if (isNested) {
    for (const [k, v] of Object.entries(raw)) {
      if (!v || typeof v !== "object") continue;
      out[String(k)] = {};
      for (const [qi, ans] of Object.entries(v)) out[String(k)][String(qi)] = parseInt(ans, 10);
    }
    return out;
  }

  // If a flat object was saved (legacy), assign it to the first quiz part we have (Task 1)
  const firstQuizIdx = parts.findIndex(p => p.type === "quiz");
  const key = String(firstQuizIdx >= 0 ? firstQuizIdx : 0);
  out[key] = {};
  for (const [qi, ans] of Object.entries(raw)) out[key][String(qi)] = parseInt(ans, 10);
  return out;
}

function normalizeQuizJustifications(raw) {
  const out = {};
  if (!raw || typeof raw !== "object") return out;
  for (const [k, v] of Object.entries(raw)) {
    if (!v || typeof v !== "object") continue;
    out[String(k)] = {};
    for (const [qi, txt] of Object.entries(v)) out[String(k)][String(qi)] = String(txt || "");
  }
  return out;
}

async function loadLessonState(uid) {
  try {
    let d = null;

    // 1) try subcollection
    try {
      const snap = await getDoc(lessonDocRef(uid));
      if (snap.exists()) d = snap.data() || {};
    } catch (err) {
      console.warn("Could not read lessons subcollection (will fallback)", err);
    }

    // 2) fallback to users/{uid}
    if (!d) {
      try {
        const us = await getDoc(userDocRef(uid));
        if (us.exists()) {
          const ud = us.data() || {};
          const key = `lesson${LESSON_NO}`;
          const nested = (ud.lessonState && typeof ud.lessonState === "object") ? ud.lessonState[key] : null;
          if (nested && typeof nested === "object") d = nested;
        }
      } catch (err) {
        console.warn("Could not read user doc fallback for lessonState", err);
      }
    }

    if (!d) return defaultLessonState();

    const arr = Array.isArray(d.partsDone) ? d.partsDone : [];
    const partsDone = parts.map((_, i) => !!arr[i]);

    const qa = normalizeQuizAnswers(d.quizAnswers);
    const qs = (d.quizScores && typeof d.quizScores === "object") ? d.quizScores : {};
    const qj = normalizeQuizJustifications(d.quizJustifications);

    const tf = emptyTaskFiles();
    const rawTF = (d.taskFiles && typeof d.taskFiles === "object") ? d.taskFiles : {};
    FILE_TASK_KEYS.forEach(k => { tf[k] = String(rawTF?.[k] || ""); });

    const assessmentFile = String(d.assessmentFile || tf.task3 || "");

    return { partsDone, quizAnswers: qa, quizScores: qs, quizJustifications: qj, taskFiles: tf, assessmentFile };
  } catch (_) {
    return defaultLessonState();
  }
}

async function saveLessonState(uid, state) {
  const taskFiles = (state.taskFiles && typeof state.taskFiles === "object") ? state.taskFiles : emptyTaskFiles();
  const legacyAssessment = String(taskFiles.task3 || state.assessmentFile || "");

  const payload = {
    partsDone: state.partsDone,
    quizAnswers: state.quizAnswers || {},
    quizScores: state.quizScores || {},
    quizJustifications: state.quizJustifications || {},
    taskFiles,
    assessmentFile: legacyAssessment,
    updatedAt: Date.now()
  };

  // Try subcollection first
  try {
    await setDoc(lessonDocRef(uid), payload, { merge: true });
  } catch (err) {
    console.warn("Firestore write failed (lessons subcollection)", err);
  }

  // Fallback: also store inside users/{uid}
  try {
    await upsertUserDocFields(uid, { [`lessonState.lesson${LESSON_NO}`]: payload });
  } catch (err) {
    console.warn("Firestore write failed (user doc lessonState)", err);
  }
}

async function saveLessonProgress(uid, pct, meta = {}) {
  const progress = clamp(parseInt(pct || "0", 10) || 0, 0, 100);
  const complete = progress === 100;

  const partsTotal = Number(meta?.partsTotal ?? parts.length) || parts.length;
  const doneCount = (meta?.doneCount != null) ? Number(meta.doneCount) : undefined;

  const payload = { progress, complete, partsTotal, updatedAt: Date.now() };
  if (Number.isFinite(doneCount)) payload.doneCount = doneCount;

  try { await setDoc(progressDocRef(uid), payload, { merge: true }); }
  catch (err) { console.warn("Firestore write failed (progress subcollection)", err); }

  try { await upsertUserDocFields(uid, { [`progress.lesson${LESSON_NO}`]: payload }); }
  catch (err) { console.warn("Firestore write failed (user doc progress)", err); }
}

function computeProgressPct(state) {
  const doneCount = state.partsDone.reduce((acc, v) => acc + (v ? 1 : 0), 0);
  return Math.round((doneCount / parts.length) * 100);
}

function pill(done) {
  if (done) {
    statusPill.textContent = "Completed";
    statusPill.className = "inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-brand-50 text-brand-800 ring-1 ring-black/5";
  } else {
    statusPill.textContent = "Not completed";
    statusPill.className = "inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-slate-100 text-slate-700 ring-1 ring-black/5";
  }
}

function renderSidebar() {
  partsList.innerHTML = "";
  parts.forEach((p, idx) => {
    const done = !!__lessonState?.partsDone?.[idx];
    const isActive = idx === activePart;

    const btn = document.createElement("button");
    btn.className =
      "w-full flex items-center justify-between gap-3 rounded-2xl px-4 py-3 text-left ring-1 ring-black/5 transition " +
      (isActive ? "bg-brand-600 text-white" : "bg-slate-50 hover:bg-slate-100 text-slate-900");

    btn.innerHTML = `
      <span class="text-sm font-semibold">${p.title}</span>
      <span class="text-xs font-bold ${isActive ? "text-white" : "text-brand-700"}">${done ? "✓" : ""}</span>
    `;

    btn.addEventListener("click", () => { activePart = idx; render(); });
    partsList.appendChild(btn);
  });
}

// Debounce helper for textarea writes
function debounce(fn, wait) {
  let t = null;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), wait);
  };
}

function renderQuizForPart(partIdx, quizData, heading, subheading) {
  const key = String(partIdx);
  const quizAnswers = (__lessonState && __lessonState.quizAnswers) ? __lessonState.quizAnswers : {};
  const saved = (quizAnswers[key] && typeof quizAnswers[key] === "object") ? quizAnswers[key] : {};

  const wrap = document.createElement("div");
  wrap.className = "space-y-5";

  const info = document.createElement("div");
  info.className = "rounded-2xl bg-slate-50 p-5 ring-1 ring-black/5";
  info.innerHTML = `
    <h3 class="text-lg font-extrabold text-slate-900">${heading || "Assessment"}</h3>
    <p class="mt-1 text-sm text-slate-600">${subheading || "Select the best answer for each item, then submit."}</p>
  `;
  wrap.appendChild(info);

  quizData.forEach((item, i) => {
    const card = document.createElement("div");
    card.className = "rounded-2xl bg-white p-5 ring-1 ring-black/5";

    const q = document.createElement("div");
    q.className = "font-semibold text-slate-900 qblock";
    q.textContent = item.qHtml ? item.qHtml : `${i + 1}. ${item.q}`;
    card.appendChild(q);

    const opts = document.createElement("div");
    opts.className = "mt-3 grid gap-2";

    item.options.forEach((opt, idx) => {
      const row = document.createElement("label");
      row.className = "flex items-center gap-3 rounded-xl bg-slate-50 px-4 py-3 hover:bg-slate-100 cursor-pointer";
      row.innerHTML = `
        <input type="radio" name="p${partIdx}q${i}" value="${idx}" class="h-4 w-4 accent-brand-600" />
        <span class="text-sm text-slate-800">${opt}</span>
      `;
      opts.appendChild(row);

      if (String(saved[i]) === String(idx)) row.querySelector("input").checked = true;

      row.querySelector("input").addEventListener("change", async (e) => {
        saved[i] = parseInt(e.target.value, 10);
        quizAnswers[key] = saved;
        __lessonState.quizAnswers = quizAnswers;
        if (__currentUser) await saveLessonState(__currentUser.uid, __lessonState);
      });
    });

    card.appendChild(opts);
    wrap.appendChild(card);
  });

  const actions = document.createElement("div");
  actions.className = "flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between";
  actions.innerHTML = `
    <button id="submitQuizBtn_${partIdx}" class="rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800">
      Submit Answers
    </button>
    <p id="quizResult_${partIdx}" class="text-sm font-semibold text-slate-700"></p>
  `;
  wrap.appendChild(actions);

  setTimeout(() => {
    document.getElementById(`submitQuizBtn_${partIdx}`).addEventListener("click", async () => {
      let correct = 0;
      quizData.forEach((it, qi) => { if (saved[qi] === it.answer) correct++; });
      const score = Math.round((correct / quizData.length) * 100);
      const result = document.getElementById(`quizResult_${partIdx}`);

      result.innerHTML = `Score: ${score}% <span class="text-slate-500">(saved)</span>`;
      result.className = "text-sm font-extrabold text-brand-800";

      __lessonState.quizScores = (__lessonState.quizScores && typeof __lessonState.quizScores === "object") ? __lessonState.quizScores : {};
      __lessonState.quizScores[key] = { score, correct, total: quizData.length, updatedAt: Date.now() };

      __lessonState.partsDone[partIdx] = true;
      if (__currentUser) await saveLessonState(__currentUser.uid, __lessonState);

      const pct = computeProgressPct(__lessonState);
      if (__currentUser) await saveLessonProgress(__currentUser.uid, pct, { doneCount: __lessonState.partsDone.reduce((a,b)=>a+(b?1:0),0), partsTotal: parts.length });

      renderSidebar();
      await renderProgress();
      pill(true);
      renderPart();
    });
  }, 0);

  return wrap;
}

function renderJustifyQuizForPart(partIdx, quizData, heading, subheading) {
  const key = String(partIdx);
  const quizAnswers = (__lessonState && __lessonState.quizAnswers) ? __lessonState.quizAnswers : {};
  const saved = (quizAnswers[key] && typeof quizAnswers[key] === "object") ? quizAnswers[key] : {};

  const quizJustifications = (__lessonState && __lessonState.quizJustifications) ? __lessonState.quizJustifications : {};
  const savedJust = (quizJustifications[key] && typeof quizJustifications[key] === "object") ? quizJustifications[key] : {};

  const debouncedSave = debounce(async () => {
    if (__currentUser) await saveLessonState(__currentUser.uid, __lessonState);
  }, 700);

  const wrap = document.createElement("div");
  wrap.className = "space-y-5";

  const info = document.createElement("div");
  info.className = "rounded-2xl bg-slate-50 p-5 ring-1 ring-black/5";
  info.innerHTML = `
    <h3 class="text-lg font-extrabold text-slate-900">${heading || "Assessment"}</h3>
    <p class="mt-1 text-sm text-slate-600">${subheading || ""}</p>
    <p class="mt-2 text-xs text-slate-500">Write a short justification for each item (mention simplicity/specificity/structure/stickiness).</p>
  `;
  wrap.appendChild(info);

  quizData.forEach((item, i) => {
    const card = document.createElement("div");
    card.className = "rounded-2xl bg-white p-5 ring-1 ring-black/5";

    const q = document.createElement("div");
    q.className = "font-semibold text-slate-900 qblock";
    q.textContent = item.qHtml ? item.qHtml : `${item.q}`;
    card.appendChild(q);

    const opts = document.createElement("div");
    opts.className = "mt-3 grid gap-2";

    item.options.forEach((opt, idx) => {
      const row = document.createElement("label");
      row.className = "flex items-start gap-3 rounded-xl bg-slate-50 px-4 py-3 hover:bg-slate-100 cursor-pointer";
      row.innerHTML = `
        <input type="radio" name="p${partIdx}q${i}" value="${idx}" class="mt-1 h-4 w-4 accent-brand-600" />
        <span class="text-sm text-slate-800">${opt}</span>
      `;
      opts.appendChild(row);

      if (String(saved[i]) === String(idx)) row.querySelector("input").checked = true;

      row.querySelector("input").addEventListener("change", async (e) => {
        saved[i] = parseInt(e.target.value, 10);
        quizAnswers[key] = saved;
        __lessonState.quizAnswers = quizAnswers;
        // do not spam writes; just quick save
        debouncedSave();
      });
    });

    card.appendChild(opts);

    const justWrap = document.createElement("div");
    justWrap.className = "mt-4";
    justWrap.innerHTML = `
      <label class="block text-sm font-semibold text-slate-800">Justification</label>
      <textarea id="just_${partIdx}_${i}" rows="3"
        class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-800 shadow-sm focus:outline-none focus:ring-4 focus:ring-brand-100"
        placeholder="Explain why your revision is best (simplicity, specificity, structure, stickiness)."></textarea>
      <p class="mt-2 text-xs text-slate-500">Tip: 1–2 sentences is enough.</p>
    `;
    card.appendChild(justWrap);
    wrap.appendChild(card);

    setTimeout(() => {
      const ta = document.getElementById(`just_${partIdx}_${i}`);
      if (!ta) return;
      ta.value = String(savedJust[i] || "");
      ta.addEventListener("input", () => {
        savedJust[i] = ta.value;
        quizJustifications[key] = savedJust;
        __lessonState.quizJustifications = quizJustifications;
        debouncedSave();
      });
    }, 0);
  });

  const actions = document.createElement("div");
  actions.className = "flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between";
  actions.innerHTML = `
    <button id="submitQuizBtn_${partIdx}" class="rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800">
      Submit Answers
    </button>
    <p id="quizResult_${partIdx}" class="text-sm font-semibold text-slate-700"></p>
  `;
  wrap.appendChild(actions);

  setTimeout(() => {
    document.getElementById(`submitQuizBtn_${partIdx}`).addEventListener("click", async () => {
      // Validate: all answered + all justifications non-empty
      for (let qi = 0; qi < quizData.length; qi++) {
        if (saved[qi] == null || isNaN(parseInt(saved[qi], 10))) {
          const r = document.getElementById(`quizResult_${partIdx}`);
          r.textContent = "Please answer all items before submitting.";
          r.className = "text-sm font-extrabold text-red-700";
          return;
        }
        const jt = String(savedJust[qi] || "").trim();
        if (jt.length < 3) {
          const r = document.getElementById(`quizResult_${partIdx}`);
          r.textContent = "Please add a short justification for each item.";
          r.className = "text-sm font-extrabold text-red-700";
          return;
        }
      }

      let correct = 0;
      quizData.forEach((it, qi) => { if (parseInt(saved[qi], 10) === it.answer) correct++; });
      const score = Math.round((correct / quizData.length) * 100);
      const result = document.getElementById(`quizResult_${partIdx}`);

      result.innerHTML = `Score: ${score}% <span class="text-slate-500">(saved)</span>`;
      result.className = "text-sm font-extrabold text-brand-800";

      __lessonState.quizScores = (__lessonState.quizScores && typeof __lessonState.quizScores === "object") ? __lessonState.quizScores : {};
      __lessonState.quizScores[key] = { score, correct, total: quizData.length, updatedAt: Date.now() };

      __lessonState.partsDone[partIdx] = true;
      if (__currentUser) await saveLessonState(__currentUser.uid, __lessonState);

      const pct = computeProgressPct(__lessonState);
      if (__currentUser) await saveLessonProgress(__currentUser.uid, pct, { doneCount: __lessonState.partsDone.reduce((a,b)=>a+(b?1:0),0), partsTotal: parts.length });

      renderSidebar();
      await renderProgress();
      pill(true);
      renderPart();
    });
  }, 0);

  return wrap;
}

function wireUploadPart(taskKey) {
  const submitFileBtn = document.getElementById(`submitFileBtn-${taskKey}`);
  const fileInput = document.getElementById(`fileInput-${taskKey}`);
  const fileStatus = document.getElementById(`fileStatus-${taskKey}`);

  const savedName = (__lessonState?.taskFiles && typeof __lessonState.taskFiles === "object") ? (__lessonState.taskFiles[taskKey] || "") : "";
  if (savedName && fileStatus) {
    fileStatus.textContent = `Last submitted: ${savedName}`;
    fileStatus.className = "mt-2 text-xs text-slate-600";
  }

  submitFileBtn?.addEventListener("click", async () => {
    if (!fileInput?.files?.length) {
      if (fileStatus) {
        fileStatus.textContent = "Please choose a file first.";
        fileStatus.className = "mt-2 text-xs text-red-600";
      }
      return;
    }

    const name = fileInput.files[0].name;

    __lessonState.taskFiles = (__lessonState.taskFiles && typeof __lessonState.taskFiles === "object") ? __lessonState.taskFiles : emptyTaskFiles();
    __lessonState.taskFiles[taskKey] = name;
    __lessonState.assessmentFile = name; // legacy (used by teacher dashboard submissions)
    __lessonState.partsDone[activePart] = true;

    if (fileStatus) {
      fileStatus.textContent = `Submitted: ${name}`;
      fileStatus.className = "mt-2 text-xs text-brand-800";
    }

    if (__currentUser) {
      await saveLessonState(__currentUser.uid, __lessonState);
      const pct = computeProgressPct(__lessonState);
      await saveLessonProgress(__currentUser.uid, pct, { doneCount: __lessonState.partsDone.reduce((a,b)=>a+(b?1:0),0), partsTotal: parts.length });
    }

    await render();
  });
}

function renderPart() {
  const p = parts[activePart];
  partTitle.textContent = p.title;
  partSubtitle.textContent = p.subtitle;

  partBody.innerHTML = "";

  if (p.type === "quiz") {
    completeBtn.classList.add("hidden");
    partBody.appendChild(renderQuizForPart(activePart, p.data, p.quizTitle, p.quizSubtitle));
  } else if (p.type === "quiz_justify") {
    completeBtn.classList.add("hidden");
    partBody.appendChild(renderJustifyQuizForPart(activePart, p.data, p.quizTitle, p.quizSubtitle));
  } else if (p.type === "upload") {
    completeBtn.classList.add("hidden");
    partBody.innerHTML = p.html;
    wireUploadPart(String(p.taskKey || "task3"));
  } else {
    completeBtn.classList.remove("hidden");
    partBody.innerHTML = p.html;
  }

  const done = !!__lessonState?.partsDone?.[activePart];
  pill(done);

  prevBtn.disabled = activePart === 0;

  // If last part is completed, Next button becomes "Next Lesson 4"
  const atLast = activePart === parts.length - 1;
  const lastDone = !!__lessonState?.partsDone?.[parts.length - 1];

  if (atLast && lastDone) {
    nextBtn.disabled = false;
    nextBtn.textContent = "Next Lesson 4 →";
    nextBtn.dataset.nextLesson = "1";
  } else {
    nextBtn.disabled = atLast;
    nextBtn.textContent = "Next →";
    nextBtn.dataset.nextLesson = "";
  }

  prevBtn.classList.toggle("opacity-50", prevBtn.disabled);
  prevBtn.classList.toggle("cursor-not-allowed", prevBtn.disabled);
  nextBtn.classList.toggle("opacity-50", nextBtn.disabled);
  nextBtn.classList.toggle("cursor-not-allowed", nextBtn.disabled);
}

async function renderProgress() {
  const pct = computeProgressPct(__lessonState);
  progressText.textContent = `${pct}%`;
  progressBar.style.width = `${pct}%`;
}

async function render() {
  renderSidebar();
  renderPart();
  await renderProgress();
}

prevBtn.addEventListener("click", async () => {
  if (activePart > 0) activePart--;
  if (__lessonState) await render();
});

nextBtn.addEventListener("click", async () => {
  if (nextBtn.dataset.nextLesson === "1") {
    window.location.href = "lesson-4.html";
    return;
  }
  if (activePart < parts.length - 1) activePart++;
  if (__lessonState) await render();
});

completeBtn.addEventListener("click", async () => {
  if (!__lessonState) return;
  __lessonState.partsDone[activePart] = true;

  if (__currentUser) {
    await saveLessonState(__currentUser.uid, __lessonState);
    const pct = computeProgressPct(__lessonState);
    await saveLessonProgress(__currentUser.uid, pct, { doneCount: __lessonState.partsDone.reduce((a,b)=>a+(b?1:0),0), partsTotal: parts.length });
  }
  await render();
});

// Auth listener: require login, enforce unlock (Lesson 2 complete), then load profile + lesson state
onAuthStateChanged(auth, async (user) => {
  __currentUser = user || null;
  if (!__currentUser) {
    window.location.href = "login.html";
    return;
  }

  // Enforce unlock: must finish Lesson 2 to view Lesson 3
  const ok = await mustHaveLesson2Complete(__currentUser.uid);
  if (!ok) {
    window.location.href = "locked.html";
    return;
  }

  // Update activity for Admin Dashboard
  try { await setDoc(doc(db, 'users', __currentUser.uid), { email: __currentUser.email || '', lastSeenAt: Date.now() }, { merge: true }); } catch (_) {}

  // Show UI instantly
  __profile = null;
  applyAuthUI();

  const [profile, lessonState] = await Promise.all([
    loadProfile(__currentUser.uid),
    loadLessonState(__currentUser.uid),
  ]);

  __profile = profile || {};
  applyAuthUI();

  __lessonState = lessonState;

  // Ensure progress doc exists/updated (fix unlocking on Lessons page)
  try {
    const pct = computeProgressPct(__lessonState);
    await saveLessonProgress(__currentUser.uid, pct, { doneCount: __lessonState.partsDone.reduce((a,b)=>a+(b?1:0),0), partsTotal: parts.length });
  } catch (_) {}

  await render();
});
    </script>

    <script type="module" src="./app.js"></script>
    <script>
      // Ensure sign-out uses Firebase
      window.signOut = () => window.__pcSignOut?.();
    </script>
  </body>
</html>
