
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson 1 | Communication Principles and Ethics</title>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: "#E7F7F5",
              100: "#CFF0EC",
              200: "#9FE1D9",
              300: "#6ED2C6",
              400: "#3EC3B3",
              500: "#13A89A",
              600: "#0F877B",
              700: "#0B665C",
              800: "#07453E",
              900: "#032420",
            },
          },
          boxShadow: { soft: "0 10px 30px rgba(0,0,0,0.10)" },
        },
      },
    };
  </script>
  <style>
    .page-bg {
      background: radial-gradient(1200px 500px at 10% -10%, rgba(19, 168, 154, 0.12), transparent 55%),
        radial-gradient(900px 450px at 100% 0%, rgba(19, 168, 154, 0.10), transparent 50%),
        #fff;
    }

    /* Simple modal animation (same feel as your profile/index) */
    .fade-in { animation: fadeIn .18s ease-out; }
    .scale-in { animation: scaleIn .18s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { transform: translateY(8px) scale(.98); } to { transform: translateY(0) scale(1); } }
  </style>
</head>

<body class="page-bg text-slate-800">

  <!-- NAVBAR ✅ EXACT SAME as lessons.html -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-100">
    <nav class="mx-auto flex max-w-7xl items-center justify-between px-4 py-4 sm:px-6 lg:px-8">
      <!-- Brand -->
      <a href="index.html" class="flex items-center gap-3">
        <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-brand-50 ring-1 ring-black/5">
          <svg viewBox="0 0 24 24" class="h-6 w-6 text-brand-700" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 7l8-4 8 4v10l-8 4-8-4V7z"></path>
            <path d="M8 11l2 2 5-5"></path>
          </svg>
        </div>
        <span class="text-lg font-semibold tracking-tight text-slate-900">Purposive Communication</span>
      </a>

      <!-- Desktop Links + Login/User Dropdown -->
      <div class="hidden items-center gap-8 md:flex">
        <a href="index.html" class="text-sm font-medium text-slate-700 hover:text-brand-700">Home</a>
        <a href="lessons.html" class="text-sm font-semibold text-brand-700">Lessons</a>

        <!-- Login (GUEST ONLY) -->
        <a href="login.html" id="openLoginBtn"
          class="auth-guest hidden rounded-xl bg-brand-500 px-5 py-2.5 text-sm font-semibold text-white shadow-soft hover:bg-brand-600">
          Login
        </a>

        <!-- User dropdown (LOGGED IN ONLY) -->
        <div class="auth-user hidden relative">
          <button id="userMenuBtn" type="button"
            class="inline-flex items-center gap-3 rounded-2xl bg-white px-2 py-1.5 ring-1 ring-black/5 shadow-sm hover:bg-slate-50 hover:shadow-soft transition"
            aria-haspopup="menu" aria-expanded="false">
            <div id="navAvatar"
              class="h-9 w-9 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center text-slate-700 font-extrabold">
              U
            </div>
            <span id="navName" class="text-sm font-semibold text-slate-900">Student</span>
            <svg id="navCaret" class="h-4 w-4 text-slate-500 transition-transform" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
            </svg>
          </button>

          <!-- Dropdown panel -->
          <div id="userDropdown"
            class="absolute right-[-10px] mt-3 hidden w-[290px] overflow-hidden rounded-3xl bg-white shadow-soft ring-1 ring-black/10">
            <div class="p-3">
              <div class="rounded-2xl bg-brand-50 p-3 ring-1 ring-brand-100">
                <div class="flex items-start gap-3">
                  <div id="ddAvatar"
                    class="h-11 w-11 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center text-slate-700 font-extrabold text-lg">
                  </div>
                  <div class="min-w-0">
                    <p id="ddName" class="truncate text-sm font-extrabold text-slate-900">Student</p>
                    <p class="text-xs font-semibold text-slate-500">Student</p>
                  </div>
                </div>
              </div>

              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center gap-3 rounded-xl bg-white px-3 py-2 ring-1 ring-black/5">
                  <svg class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M22 6l-10 7L2 6" />
                  </svg>
                  <span id="ddEmail" class="truncate text-slate-700">email@example.com</span>
                </div>

                <div class="flex items-center gap-3 rounded-xl bg-white px-3 py-2 ring-1 ring-black/5">
                  <svg class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <rect x="3" y="5" width="18" height="14" rx="2" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 15h4" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 9h10" />
                  </svg>
                  <span class="text-slate-700">ID: <span id="ddId" class="font-semibold text-slate-800">—</span></span>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-2 gap-2">
                <a href="profile.html"
                  class="inline-flex items-center justify-center rounded-2xl bg-brand-800 px-4 py-2.5 text-sm font-semibold text-white hover:bg-brand-900 transition">
                  View profile
                </a>
                <button id="signOutBtn" type="button"
                  class="inline-flex items-center justify-center rounded-2xl bg-slate-100 px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-200 transition">
                  Sign out
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile -->
      <button id="menuBtn"
        class="inline-flex items-center justify-center rounded-xl bg-slate-50 p-2 text-slate-800 ring-1 ring-black/5 hover:bg-slate-100 md:hidden"
        aria-label="Open menu" aria-expanded="false">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mx-auto hidden max-w-7xl px-4 pb-4 sm:px-6 lg:px-8 md:hidden">
      <div class="rounded-2xl bg-white p-4 shadow-soft ring-1 ring-black/5">
        <div class="flex flex-col gap-2">
          <a href="index.html"
            class="rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">Home</a>
          <a href="lessons.html"
            class="rounded-xl px-3 py-2 text-sm font-semibold text-brand-700 bg-brand-50">Lessons</a>
          <a href="profile.html"
            class="rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">Profile</a>

          <!-- Login (GUEST ONLY) -->
          <a href="login.html" id="openLoginMobile"
            class="auth-guest hidden mt-2 rounded-xl bg-brand-500 px-4 py-2.5 text-center text-sm font-semibold text-white hover:bg-brand-600">
            Login
          </a>

          <!-- Logged-in block (MOBILE ONLY) -->
          <div class="auth-user hidden mt-2 rounded-2xl bg-white ring-1 ring-black/5 p-3">
            <div class="flex items-center gap-3">
              <div id="mNavAvatar"
                class="h-10 w-10 rounded-full bg-slate-100 ring-1 ring-black/5 flex items-center justify-center font-extrabold text-slate-700">
                U
              </div>
              <div class="min-w-0">
                <p id="mNavName" class="truncate text-sm font-extrabold text-slate-900">Student</p>
                <p id="mNavEmail" class="truncate text-xs font-semibold text-slate-500">email@example.com</p>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <a href="profile.html"
                class="rounded-xl bg-brand-800 px-3 py-2 text-center text-sm font-semibold text-white hover:bg-brand-900">View
                profile</a>
              <button id="mSignOutBtn"
                class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200">Sign
                out</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="bg-brand-700">
    <div class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div>
          <p class="text-white/80 text-sm font-semibold">Lesson 1</p>
          <h1 class="mt-1 text-3xl sm:text-4xl font-extrabold tracking-tight text-white">
            Communication Principles and Ethics
          </h1>
          <p class="mt-3 max-w-3xl text-white/85">
            Parts: Principles of Effective Communication • Communication and Globalization • Ethics in Communication • Tasks 1–4 (File Submission)
          </p>
        </div>

        <div class="w-full md:w-[340px]">
          <div class="rounded-2xl bg-white/10 ring-1 ring-white/15 p-4">
            <div class="flex items-center justify-between text-sm text-white/90">
              <span class="font-semibold">Lesson Progress</span>
              <span id="progressText" class="font-bold">0%</span>
            </div>
            <div class="mt-3 h-2.5 w-full rounded-full bg-white/20">
              <div id="progressBar" class="h-2.5 w-0 rounded-full bg-white transition-all"></div>
            </div>
            <p class="mt-2 text-xs text-white/70">MCQ requires passing score to complete.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <main class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8">
    <div class="grid gap-8 lg:grid-cols-12">
      <!-- Sidebar -->
      <aside class="lg:col-span-3">
        <div class="rounded-3xl bg-white shadow-soft ring-1 ring-black/5 p-5 sticky top-24">
          <h2 class="text-sm font-extrabold text-slate-900">Lesson Parts</h2>
          <div id="partsList" class="mt-4 space-y-2"></div>

          <div class="mt-5 rounded-2xl bg-brand-50 p-4 ring-1 ring-black/5">
            <p class="text-xs font-semibold text-brand-800">Tip</p>
            <p class="mt-1 text-xs text-slate-600">
              Mark each part as completed to update the progress bar. This will sync to Firebase.
            </p>
          </div>
        </div>
      </aside>

      <!-- Main panel -->
      <section class="lg:col-span-9">
        <div class="rounded-3xl bg-white shadow-soft ring-1 ring-black/5 p-6 sm:p-8">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 id="partTitle" class="text-2xl font-extrabold text-slate-900"></h2>
              <p id="partSubtitle" class="mt-2 text-sm text-slate-600"></p>
            </div>

            <div class="flex items-center gap-2">
              <span id="statusPill"
                class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ring-1 ring-black/5">
                Not completed
              </span>
            </div>
          </div>

          <div id="partBody" class="mt-6 space-y-6"></div>

          <div class="mt-8 flex flex-col-reverse gap-3 sm:flex-row sm:items-center sm:justify-between">
            <button id="prevBtn"
              class="rounded-xl bg-slate-100 px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-200 ring-1 ring-black/5">
              ← Previous
            </button>

            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-end">
              <button id="completeBtn"
                class="rounded-xl bg-brand-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-brand-700 ring-1 ring-black/5">
                Mark Part as Completed
              </button>
              <button id="nextBtn"
                class="rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800 ring-1 ring-black/5">
                Next →
              </button>
            </div>
          </div>
        </div>

        <p class="mt-4 text-xs text-slate-500">
          Note: Each task submission is stored in Firestore as a filename only (no upload storage yet).
        </p>
      </section>
    </div>
  </main>

  <!-- ✅ SIGN OUT CONFIRM MODAL (same as index.html) -->
  <div id="signOutModal" class="fixed inset-0 z-[95] hidden">
    <div id="signOutBackdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm fade-in"></div>

    <div class="relative mx-auto flex min-h-full max-w-md items-center justify-center px-4 py-10">
      <div class="w-full rounded-3xl bg-white shadow-soft ring-1 ring-black/10 scale-in">
        <div class="p-5 sm:p-6 text-center">
          <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-2xl bg-brand-50 ring-1 ring-black/5">
            <svg viewBox="0 0 24 24" class="h-6 w-6 text-brand-700" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v5" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 16h.01" />
            </svg>
          </div>

          <h3 class="mt-3 text-base font-extrabold text-slate-900">Are you sure you want to sign out?</h3>

          <div class="mt-5 grid grid-cols-2 gap-3">
            <button id="signOutNo" type="button"
              class="w-full rounded-xl bg-slate-100 px-5 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-200 ring-1 ring-black/5">
              No
            </button>

            <button id="signOutYes" type="button"
              class="w-full rounded-xl bg-brand-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-brand-700 ring-1 ring-black/5">
              Yes
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Firebase only (NO localStorage) -->
  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      onAuthStateChanged,
      signOut as firebaseSignOut,
      setPersistence,
      browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      doc,
      getDoc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Force Firebase auth to NOT use localStorage (session only)
    try { await setPersistence(auth, browserSessionPersistence); } catch (_) { }

    // ===== Auth dropdown (Firebase) =====
    const guestEls = Array.from(document.querySelectorAll(".auth-guest"));
    const userEls = Array.from(document.querySelectorAll(".auth-user"));

    const userMenuBtn = document.getElementById("userMenuBtn");
    const userDropdown = document.getElementById("userDropdown");
    const navCaret = document.getElementById("navCaret");

    const navName = document.getElementById("navName");
    const navAvatar = document.getElementById("navAvatar");

    const ddName = document.getElementById("ddName");
    const ddEmail = document.getElementById("ddEmail");
    const ddId = document.getElementById("ddId");
    const ddAvatar = document.getElementById("ddAvatar");

    const mNavName = document.getElementById("mNavName");
    const mNavEmail = document.getElementById("mNavEmail");
    const mNavAvatar = document.getElementById("mNavAvatar");

    const signOutBtn = document.getElementById("signOutBtn");
    const mSignOutBtn = document.getElementById("mSignOutBtn");

    let __currentUser = null;
    let __profile = null;

    function isLoggedIn() { return !!__currentUser; }

    function getInitials(nameOrEmail) {
      const n = (nameOrEmail || "").trim();
      if (!n) return "U";
      const parts = n.split(/\s+/).filter(Boolean);
      if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      return (parts[0][0] || "U").toUpperCase();
    }

    function setAvatarEl(el, text) {
      if (!el) return;
      el.textContent = text || "U";
    }

    function closeUserDropdown() {
      if (!userDropdown || !userMenuBtn) return;
      userDropdown.classList.add("hidden");
      userMenuBtn.setAttribute("aria-expanded", "false");
      navCaret?.classList.remove("rotate-180");
    }

    function openUserDropdown() {
      if (!userDropdown || !userMenuBtn) return;
      userDropdown.classList.remove("hidden");
      userMenuBtn.setAttribute("aria-expanded", "true");
      navCaret?.classList.add("rotate-180");
    }

    function toggleUserDropdown() {
      if (!userDropdown) return;
      const isOpen = !userDropdown.classList.contains("hidden");
      if (isOpen) closeUserDropdown();
      else openUserDropdown();
    }

    userMenuBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      toggleUserDropdown();
    });

    document.addEventListener("click", (e) => {
      if (!userDropdown || userDropdown.classList.contains("hidden")) return;
      const wrapper = userMenuBtn?.parentElement; // .auth-user
      if (wrapper && e.target instanceof Node && !wrapper.contains(e.target)) closeUserDropdown();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeUserDropdown();
    });

    function maybeRedirectLocked(p) {
      const role = String(p?.role || "student").toLowerCase().trim();
      if (role === "student" && p?.locked === true) {
        const here = String(window.location.href || "").toLowerCase();
        if (!here.endsWith("locked.html")) {
          window.location.href = "locked.html";
          return true;
        }
      }
      return false;
    }

    async function loadProfile(uid) {
      try {
        const snap = await getDoc(doc(db, "users", uid));
        const p = snap.exists() ? (snap.data() || {}) : {};
        maybeRedirectLocked(p);
        return p;
      } catch (_) {
        return {};
      }
    }


    function applyAuthUI() {
      const loggedIn = isLoggedIn();

      guestEls.forEach(el => el.classList.toggle("hidden", loggedIn));
      userEls.forEach(el => el.classList.toggle("hidden", !loggedIn));

      if (!loggedIn) {
        closeUserDropdown();
        return;
      }

      const fullName = (__profile?.fullName || __currentUser?.displayName || "Student").trim() || "Student";
      const email = (__profile?.email || __currentUser?.email || "").trim();
      const studentId = (__profile?.studentId || "").trim();

      const avatarText = (__profile?.avatar?.type === "emoji" && __profile?.avatar?.value)
        ? __profile.avatar.value
        : getInitials(fullName || email);

      if (navName) navName.textContent = fullName;
      if (ddName) ddName.textContent = fullName;
      if (ddEmail) ddEmail.textContent = email;
      if (ddId) ddId.textContent = studentId ? studentId : "—";

      setAvatarEl(navAvatar, avatarText);
      setAvatarEl(ddAvatar, avatarText);

      if (mNavName) mNavName.textContent = fullName;
      if (mNavEmail) mNavEmail.textContent = email;
      setAvatarEl(mNavAvatar, avatarText);
    }

    // ===== Sign out confirm (WHAT TO CHANGE/UPDATE) =====
    const signOutModal = document.getElementById("signOutModal");
    const signOutBackdrop = document.getElementById("signOutBackdrop");
    const signOutYes = document.getElementById("signOutYes");
    const signOutNo = document.getElementById("signOutNo");

    function openSignOutModal() {
      closeUserDropdown();
      signOutModal?.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");
    }
    function closeSignOutModal() {
      signOutModal?.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }

    signOutNo?.addEventListener("click", closeSignOutModal);
    signOutBackdrop?.addEventListener("click", closeSignOutModal);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && signOutModal && !signOutModal.classList.contains("hidden")) closeSignOutModal();
    });

    async function doSignOut() {
      try { await firebaseSignOut(auth); } catch (_) { }
      __currentUser = null;
      __profile = null;
      closeUserDropdown();
      applyAuthUI();
      closeSignOutModal();
      window.location.href = "index.html";
    }

    window.__pcSignOut = doSignOut;

    // ✅ update: open modal instead of direct sign out
    signOutBtn?.addEventListener("click", (e) => { e.preventDefault(); openSignOutModal(); });
    mSignOutBtn?.addEventListener("click", (e) => { e.preventDefault(); openSignOutModal(); });

    signOutYes?.addEventListener("click", async () => {
      closeSignOutModal();
      await doSignOut();
    });

    // Nav mobile
    const menuBtn = document.getElementById("menuBtn");
    const mobileMenu = document.getElementById("mobileMenu");
    menuBtn?.addEventListener("click", () => {
      const isOpen = !mobileMenu.classList.contains("hidden");
      mobileMenu.classList.toggle("hidden");
      menuBtn.setAttribute("aria-expanded", String(!isOpen));
    });

    // =====================
    // Lesson 1: Parts + Tasks (Firestore per user)
    // =====================
    const LESSON_NO = 1;

    function uploadPartHtml(taskKey, taskTitle, taskBodyHtml) {
      return `
        <div class="rounded-2xl bg-slate-50 p-5 ring-1 ring-black/5">
          <h3 class="text-lg font-extrabold text-slate-900">${taskTitle}</h3>
          <div class="mt-3 space-y-3 text-sm text-slate-700">
            ${taskBodyHtml}
          </div>

          <div class="mt-5">
            <label class="block text-sm font-semibold text-slate-800">Upload your file</label>
            <input id="fileInput-${taskKey}" type="file" class="mt-2 block w-full text-sm file:mr-4 file:rounded-xl file:border-0 file:bg-brand-600 file:px-4 file:py-2 file:text-white file:font-semibold hover:file:bg-brand-700" />
            <button id="submitFileBtn-${taskKey}" class="mt-3 rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800">
              Submit File
            </button>
            <p id="fileStatus-${taskKey}" class="mt-2 text-xs text-slate-600"></p>
          </div>
        </div>
      `;
    }

    const parts = [
      {
        title: "Part 1 — Principles of Effective Communication",
        subtitle: "Clarity, conciseness, completeness, organization, empathy, and flexibility.",
        type: "content",
        showVideo: true,
        html: `
            <div class="rounded-2xl overflow-hidden ring-1 ring-black/5">
              <div class="aspect-video bg-black">
                <iframe class="w-full h-full"
                  src="https://www.youtube.com/embed/8S0FDjFBj8o"
                  title="Lesson Video (Fallback)"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen></iframe>
              </div>
            </div>

            <div class="prose max-w-none prose-slate">
              <h3>Why communication matters for technology students</h3>
              <p>
                Communication is essential in the technology industry—being technically skilled is not enough if you cannot explain ideas clearly
                to clients, managers, and teammates. Communication includes verbal, non-verbal, written, and visual forms, and effective
                communication requires audience analysis and awareness of barriers.
              </p>

              <h3>Principles of effective communication</h3>
              <ul>
                <li><strong>Clarity</strong> — use language your audience understands and choose the right channel; make purpose clear.</li>
                <li><strong>Conciseness</strong> — be brief but meaningful; avoid unnecessary details.</li>
                <li><strong>Completeness</strong> — include necessary information so the receiver can act without guessing.</li>
                <li><strong>Organization</strong> — present ideas logically and in a structured flow.</li>
                <li><strong>Empathy</strong> — consider audience needs and feelings; adjust if they look confused or overwhelmed.</li>
                <li><strong>Flexibility</strong> — adapt style, tone, and detail level for different people (manager vs engineer vs client).</li>
              </ul>
            </div>
          `,
      },
      {
        title: "Part 2 — Communication and Globalization",
        subtitle: "Cultural sensitivity and adaptability in global teams and audiences.",
        type: "content",
        showVideo: false,
        html: `
            <div class="prose max-w-none prose-slate">
              <p>
                Globalization and digitization have made people interact across countries and cultures more than ever. For future tech
                professionals, this means collaborating with diverse teammates, clients, and managers. Beyond language (often English),
                global communication requires cultural sensitivity.
              </p>

              <h3>Why cultural awareness matters</h3>
              <ul>
                <li>Words, symbols, gestures, and designs can be interpreted differently across cultures.</li>
                <li>Insensitivity can damage brands and relationships (even small design or wording choices can offend).</li>
                <li>Even everyday behaviors may be polite in one culture and rude in another.</li>
              </ul>

              <p>
                The key message: global communication requires <strong>awareness</strong>, <strong>respect</strong>, and <strong>adaptability</strong>
                in how you speak, write, and present technical information.
              </p>
            </div>
          `,
      },
      {
        title: "Part 3 — Ethics in Communication",
        subtitle: "Honesty, transparency, respect, and confidentiality in workplace communication.",
        type: "content",
        showVideo: false,
        html: `
            <div class="prose max-w-none prose-slate">
              <p>
                In the technology industry, communication must not only be clear—it must be <strong>ethical</strong>. Ethical communication
                means being accurate, honest, respectful, and responsible with information. Unethical communication may involve hiding truth,
                exaggerating results, or misleading others. Even without intent, poor choices can still cause harm.
              </p>

              <h3>Why ethics is critical in tech</h3>
              <ul>
                <li>You will handle sensitive data (project info, client records, system reports).</li>
                <li>Misleading reports and careless messages can destroy trust and credibility.</li>
                <li>Professionalism includes protecting confidential information.</li>
              </ul>

              <p>
                Ethical communication builds trust, strengthens partnerships, and reflects professional integrity.
              </p>
            </div>
          `,
      },

      // ✅ Tasks (each task has its own upload + saved filename)
      {
        title: "Task 1 — Forms of Communication (Upload File)",
        subtitle: "Upload your output for Task 1.",
        type: "upload",
        taskKey: "task1",
        showVideo: false,
        html: uploadPartHtml(
          "task1",
          "Task 1 — Forms of Communication",
          `
<div class="rounded-xl bg-white p-4 ring-1 ring-black/5">
              <p class="font-semibold">Instructions</p>
              <ol class="mt-2 list-decimal pl-5 space-y-2">
                <li>
                  Choose <strong>one technical topic</strong> (e.g., system update, construction progress, or food service issue).
                </li>
                <li>
                  Explain how you would use the <strong>four forms of communication</strong> to share the information:
                  <strong>verbal</strong>, <strong>non-verbal</strong>, <strong>written</strong>, and <strong>visual</strong>.
                </li>
                <li>
                  Write <strong>one short message (4–5 sentences)</strong> tailored for a specific audience:
                  <strong>client</strong>, <strong>manager</strong>, or <strong>peer</strong>.
                </li>
                <li>
                  Identify <strong>one possible communication barrier</strong> for that audience and explain how you would overcome it.
                </li>
              </ol>
            </div>
`
        ),
      },
      {
        title: "Task 2 — Incident Report (Upload File)",
        subtitle: "Upload your output for Task 2.",
        type: "upload",
        taskKey: "task2",
        showVideo: false,
        html: uploadPartHtml(
          "task2",
          "Task 2 — Incident Report",
          `
<div class="rounded-xl bg-white p-4 ring-1 ring-black/5">
              <p class="font-semibold">Instructions</p>
              <p class="mt-2">
                During a routine system check (or workplace task), you discovered a minor issue that temporarily slowed down operations but was quickly resolved.
                Write a <strong>5–7 sentence incident report</strong> for your supervisor that:
              </p>
              <ul class="mt-2 list-disc pl-5 space-y-1">
                <li>States the problem with <strong>clarity</strong></li>
                <li>Keeps the explanation <strong>concise</strong> but <strong>complete</strong> (include cause, action taken, and resolution)</li>
                <li>Shows <strong>organization</strong> (logical flow: issue → action → result)</li>
                <li>Demonstrates <strong>empathy</strong> (acknowledge concerns about efficiency)</li>
                <li>Uses <strong>flexibility</strong> (professional tone suited for workplace communication)</li>
              </ul>
            </div>
`
        ),
      },
      {
        title: "Task 3 — Video Presentation (Upload File)",
        subtitle: "Upload your output for Task 3.",
        type: "upload",
        taskKey: "task3",
        showVideo: false,
        html: uploadPartHtml(
          "task3",
          "Task 3 — Video Presentation",
          `
<div class="rounded-xl bg-white p-4 ring-1 ring-black/5">
              <p class="font-semibold">Instructions</p>
              <p class="mt-2">
                Create a <strong>2–3 minute video presentation</strong> introducing a technical product, service, or project update to an international audience.
              </p>
              <ul class="mt-2 list-disc pl-5 space-y-1">
                <li>Choose <strong>two different audiences</strong> (e.g., Filipino client & Japanese manager; American engineer & local community partner)</li>
                <li>Show how you adapt <strong>tone</strong>, <strong>language</strong>, and <strong>examples</strong> for each audience</li>
                <li>Demonstrate <strong>cultural sensitivity</strong> (avoid jargon, respect etiquette, use visuals/gestures appropriately)</li>
                <li>End with a short reflection: <em>“What communication barrier might occur, and how would I overcome it?”</em></li>
              </ul>
              <p class="mt-2 text-xs text-slate-500">
                Tip: If your output is a video link, you can upload a small text/PDF file containing the link.
              </p>
            </div>
`
        ),
      },
      {
        title: "Task 4 — Formal Email (Upload File)",
        subtitle: "Upload your output for Task 4.",
        type: "upload",
        taskKey: "task4",
        showVideo: false,
        html: uploadPartHtml(
          "task4",
          "Task 4 — Formal Workplace Email",
          `
<div class="rounded-xl bg-white p-4 ring-1 ring-black/5">
              <p class="font-semibold">Instructions</p>
              <p class="mt-2">
                You discovered a project will be delayed because of a supplier issue, but the client expects on-time completion.
                Write a <strong>formal workplace email (8–10 sentences)</strong> addressed to the client that:
              </p>
              <ul class="mt-2 list-disc pl-5 space-y-1">
                <li>Explains the situation with <strong>honesty</strong> (state the delay clearly)</li>
                <li>Shows <strong>transparency</strong> (share the reason and expected resolution)</li>
                <li>Demonstrates <strong>respect</strong> (polite, professional language)</li>
                <li>Maintains <strong>confidentiality</strong> (avoid sensitive internal details)</li>
              </ul>
            </div>
`
        ),
      },
    ];

    // ---------------------
    // UI helpers
    // ---------------------
    const partsList = document.getElementById("partsList");
    const partTitle = document.getElementById("partTitle");
    const partSubtitle = document.getElementById("partSubtitle");
    const partBody = document.getElementById("partBody");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const completeBtn = document.getElementById("completeBtn");
    const progressText = document.getElementById("progressText");
    const progressBar = document.getElementById("progressBar");
    const statusPill = document.getElementById("statusPill");

    let activePart = 0;

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function lessonDocRef(uid) {
      return doc(db, "users", uid, "lessons", `lesson${LESSON_NO}`);
    }

    function progressDocRef(uid) {
      return doc(db, "users", uid, "progress", `lesson${LESSON_NO}`);
    }


    function userDocRef(uid) {
      return doc(db, "users", uid);
    }

    async function upsertUserDocFields(uid, data) {
      const ref = userDocRef(uid);
      try {
        await updateDoc(ref, data);
      } catch (err) {
        try {
          await setDoc(ref, data, { merge: true });
        } catch (err2) {
          console.warn("Firestore write failed (user doc fallback)", err2);
        }
      }
    }


    const TASK_KEYS = ["task1", "task2", "task3", "task4"];

    function emptyTaskFiles() {
      return TASK_KEYS.reduce((acc, k) => { acc[k] = ""; return acc; }, {});
    }

    function defaultLessonState() {
      // Keep assessmentFile for backwards compatibility with older dashboards
      return {
        partsDone: parts.map(() => false),
        taskFiles: emptyTaskFiles(),
        assessmentFile: "",
      };
    }

    async function loadLessonState(uid) {
      try {
        let d = null;
          try {
            const snap = await getDoc(lessonDocRef(uid));
            if (snap.exists()) d = snap.data() || {};
          } catch (err) {
            console.warn("Could not read lessons subcollection (will fallback)", err);
          }

          if (!d) {
            try {
              const us = await getDoc(userDocRef(uid));
              if (us.exists()) {
                const ud = us.data() || {};
                const key = `lesson${LESSON_NO}`;
                const nested = (ud.lessonState && typeof ud.lessonState === "object") ? ud.lessonState[key] : null;
                if (nested && typeof nested === "object") d = nested;
              }
            } catch (err) {
              console.warn("Could not read user doc fallback for lessonState", err);
            }
          }

          if (!d) return defaultLessonState();

        const arr = Array.isArray(d.partsDone) ? d.partsDone : [];
        // Map stored partsDone onto the current parts list length
        const partsDone = parts.map((_, i) => {
          if (i < arr.length) return !!arr[i];
          // Migration: older Lesson 1 had 4 parts; the old Assessment was index 3
          if (arr.length === 4 && i == 3) return !!arr[3];
          return false;
        });

        const taskFiles = emptyTaskFiles();
        if (d.taskFiles && typeof d.taskFiles === "object") {
          for (const k of TASK_KEYS) taskFiles[k] = String(d.taskFiles?.[k] || "");
        } else if (d.assessmentFile) {
          // Legacy single submission becomes Task 1
          taskFiles.task1 = String(d.assessmentFile || "");
        }

        const assessmentFile = String(d.assessmentFile || taskFiles.task1 || "");

        return { partsDone, taskFiles, assessmentFile };
      } catch (_) {
        return defaultLessonState();
      }
    }

    async function saveLessonState(uid, state) {
      const taskFiles = (state.taskFiles && typeof state.taskFiles === "object") ? state.taskFiles : emptyTaskFiles();
      // Legacy field used by teacher dashboard; keep a best-effort value
      const legacyAssessment = String(
        taskFiles.task4 || taskFiles.task3 || taskFiles.task2 || taskFiles.task1 || state.assessmentFile || ""
      );

      const payload = {
        partsDone: state.partsDone,
        taskFiles,
        assessmentFile: legacyAssessment,
        updatedAt: Date.now()
      };

      // Try subcollection first
      try {
        await setDoc(lessonDocRef(uid), payload, { merge: true });
      } catch (err) {
        console.warn("Firestore write failed (lessons subcollection)", err);
      }

      // Fallback: also write into users/{uid} doc (avoids needing subcollection rules)
      try {
        await upsertUserDocFields(uid, { [`lessonState.lesson${LESSON_NO}`]: payload });
      } catch (err) {
        console.warn("Firestore write failed (user doc lessonState)", err);
      }
    }

    async function saveLessonProgress(uid, pct, meta = {}) {
      const progress = clamp(parseInt(pct || "0", 10) || 0, 0, 100);
      const complete = progress === 100;

      const partsTotal = Number(meta?.partsTotal ?? parts.length) || parts.length;
      const doneCount = (meta?.doneCount != null) ? Number(meta.doneCount) : undefined;

      const payload = { progress, complete, partsTotal, updatedAt: Date.now() };
      if (Number.isFinite(doneCount)) payload.doneCount = doneCount;

      try {

        await setDoc(progressDocRef(uid), payload, { merge: true });

      } catch (err) {

        console.warn("Firestore write failed (progress subcollection)", err);

      }


      try {

        await upsertUserDocFields(uid, { [`progress.lesson${LESSON_NO}`]: payload });

      } catch (err) {

        console.warn("Firestore write failed (user doc progress)", err);

      }
    }

    function computeProgressPct(state) {
      const doneCount = state.partsDone.reduce((a, b) => a + (b ? 1 : 0), 0);
      return Math.round((doneCount / parts.length) * 100);
    }

    function pill(done) {
      if (done) {
        statusPill.textContent = "Completed";
        statusPill.className =
          "inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-brand-50 text-brand-800 ring-1 ring-black/5";
      } else {
        statusPill.textContent = "Not completed";
        statusPill.className =
          "inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-slate-100 text-slate-700 ring-1 ring-black/5";
      }
    }

    function renderSidebar(state) {
      partsList.innerHTML = "";
      parts.forEach((p, idx) => {
        const done = !!state.partsDone[idx];
        const isActive = idx === activePart;

        const btn = document.createElement("button");
        btn.className =
          "w-full flex items-center justify-between gap-3 rounded-2xl px-4 py-3 text-left ring-1 ring-black/5 transition " +
          (isActive ? "bg-brand-600 text-white" : "bg-slate-50 hover:bg-slate-100 text-slate-900");

        btn.innerHTML = `
            <span class="text-sm font-semibold">${p.title}</span>
            <span class="inline-flex items-center gap-2">
              ${done
            ? `<span class="text-xs font-bold ${isActive ? "text-white" : "text-brand-700"}">✓</span>`
            : `<span class="text-xs ${isActive ? "text-white/80" : "text-slate-400"}">•</span>`}
            </span>
          `;

        btn.addEventListener("click", () => {
          activePart = idx;
          render(state);
        });

        partsList.appendChild(btn);
      });
    }

    function renderPart(state) {
      const p = parts[activePart];
      partTitle.textContent = p.title;
      partSubtitle.textContent = p.subtitle;
      partBody.innerHTML = p.html;

      const done = !!state.partsDone[activePart];
      pill(done);

      // Hide manual completion for upload tasks (completion happens on submit)
      const isUpload = p.type === "upload";
      completeBtn.classList.toggle("hidden", isUpload);
      completeBtn.disabled = isUpload;

      prevBtn.disabled = activePart === 0;

      // ✅ CHANGE: if last part is completed, Next button becomes "Next Lesson" and goes to Lesson 2
      const atLast = activePart === parts.length - 1;
      const lastDone = !!state.partsDone[parts.length - 1];

      if (atLast && lastDone) {
        nextBtn.disabled = false;
        nextBtn.textContent = "Next Lesson 2 →";
        nextBtn.dataset.nextLesson = "1";
      } else {
        nextBtn.disabled = atLast;
        nextBtn.textContent = "Next →";
        nextBtn.dataset.nextLesson = "";
      }

      prevBtn.classList.toggle("opacity-50", prevBtn.disabled);
      prevBtn.classList.toggle("cursor-not-allowed", prevBtn.disabled);
      nextBtn.classList.toggle("opacity-50", nextBtn.disabled);
      nextBtn.classList.toggle("cursor-not-allowed", nextBtn.disabled);

      if (p.type === "upload") {
        const key = String(p.taskKey || "").trim();
        const submitFileBtn = document.getElementById(`submitFileBtn-${key}`);
        const fileInput = document.getElementById(`fileInput-${key}`);
        const fileStatus = document.getElementById(`fileStatus-${key}`);

        const savedName = (state.taskFiles && typeof state.taskFiles === "object") ? String(state.taskFiles[key] || "") : "";
        if (savedName) fileStatus.textContent = `Last submitted: ${savedName}`;

        submitFileBtn?.addEventListener("click", async () => {
          if (!fileInput?.files?.length) {
            fileStatus.textContent = "Please choose a file first.";
            fileStatus.className = "mt-2 text-xs text-red-600";
            return;
          }
          const name = fileInput.files[0].name;

          if (!state.taskFiles || typeof state.taskFiles !== "object") state.taskFiles = emptyTaskFiles();
          state.taskFiles[key] = name;
          state.assessmentFile = name; // legacy
          state.partsDone[activePart] = true;

          fileStatus.textContent = `Submitted: ${name}`;
          fileStatus.className = "mt-2 text-xs text-brand-800";

          if (__currentUser) {
            await saveLessonState(__currentUser.uid, state);
            const pct = computeProgressPct(state);
            await saveLessonProgress(__currentUser.uid, pct, { doneCount: state.partsDone.reduce((a,b)=>a+(b?1:0),0), partsTotal: parts.length });
          }

          render(state);
        });
      }
    }

    async function renderProgress(state) {
      const pct = computeProgressPct(state);
      progressText.textContent = `${pct}%`;
      progressBar.style.width = `${pct}%`;
    }

    async function render(state) {
      renderSidebar(state);
      renderPart(state);
      await renderProgress(state);
    }

    // Buttons wiring
    prevBtn.addEventListener("click", async () => {
      if (activePart > 0) activePart--;
      if (__lessonState) await render(__lessonState);
    });

    nextBtn.addEventListener("click", async () => {
      // ✅ CHANGE: if ready for next lesson, go to Lesson 2
      if (nextBtn.dataset.nextLesson === "1") {
        window.location.href = "lesson-2.html";
        return;
      }

      if (activePart < parts.length - 1) activePart++;
      if (__lessonState) await render(__lessonState);
    });

    completeBtn.addEventListener("click", async () => {
      if (!__lessonState) return;
      __lessonState.partsDone[activePart] = true;

      if (__currentUser) {
        await saveLessonState(__currentUser.uid, __lessonState);
        const pct = computeProgressPct(__lessonState);
        await saveLessonProgress(__currentUser.uid, pct, { doneCount: __lessonState.partsDone.reduce((a,b)=>a+(b?1:0),0), partsTotal: parts.length });
      }

      await render(__lessonState);
    });

    let __lessonState = null;

    // ✅ Auth listener: require login, load profile + lesson state for that user
    onAuthStateChanged(auth, async (user) => {
      __currentUser = user || null;

      // ✅ CHANGED: removed alert (no more popup)
      if (!__currentUser) {
        window.location.href = "login.html";
        return;
      }


      // Update activity for Admin Dashboard
      try { await setDoc(doc(db, 'users', __currentUser.uid), { email: __currentUser.email || '', lastSeenAt: Date.now() }, { merge: true }); } catch (_) {}
      // show UI instantly
      __profile = null;
      applyAuthUI();

      const [profile, lessonState] = await Promise.all([
        loadProfile(__currentUser.uid),
        loadLessonState(__currentUser.uid),
      ]);

      __profile = profile || {};
      applyAuthUI();

      __lessonState = lessonState;

      // Ensure progress doc exists/updated (fix unlocking on Lessons page)
      try {
        const pct = computeProgressPct(__lessonState);
        await saveLessonProgress(__currentUser.uid, pct, { doneCount: __lessonState.partsDone.reduce((a,b)=>a+(b?1:0),0), partsTotal: parts.length });
      } catch (_) { }

      await render(__lessonState);
    });
  </script>

  <script type="module" src="./app.js"></script>
  <script>
    // Ensure sign-out uses Firebase
    window.signOut = () => window.__pcSignOut?.();
  </script>
</body>

</html>
